<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CEE AI — Neon Cyberpunk Exam Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
/* =======================================================
   NEON CYBERPUNK THEME - CEE AI EXAM PORTAL
   Extensive CSS for premium look and animations
   ======================================================= */
:root{
  --bg1: #07030b;
  --bg2: #140824;
  --glass: rgba(255,255,255,0.03);
  --card: rgba(255,255,255,0.03);
  --muted: rgba(255,255,255,0.65);
  --neon-a: #7ef1ff;
  --neon-b: #b37cff;
  --neon-c: #ff6fb5;
  --correct: #00ff9e;
  --wrong: #ff4d6d;
  --accent-glow: 0 10px 40px rgba(179,124,255,0.12), 0 2px 6px rgba(126,241,255,0.06);
  --glass-border: rgba(255,255,255,0.04);
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; background: radial-gradient(800px 500px at 10% 10%, rgba(179,124,255,0.04), transparent), linear-gradient(120deg,var(--bg1),var(--bg2)); color:#fff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
.container { max-width:1180px; margin:26px auto; padding:18px; display:grid; grid-template-columns: 1fr 360px; gap:20px; align-items:start; }

/* Header */
.header { grid-column:1/-1; display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px; }
.brand { display:flex; gap:12px; align-items:center; }
.logo { width:64px; height:64px; border-radius:12px; background: linear-gradient(135deg,var(--neon-a),var(--neon-b)); display:flex; align-items:center; justify-content:center; color:#041024; font-weight:800; font-size:20px; box-shadow: var(--accent-glow); }
.title { font-size:20px; font-weight:800; letter-spacing:0.4px; }
.subtitle { color:var(--muted); font-size:13px; margin-top:2px; }

/* Left: main card */
.card {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:14px; padding:18px; box-shadow: 0 20px 45px rgba(0,0,0,0.6); border: 1px solid var(--glass-border);
}

/* Mode buttons */
.modes { display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap; }
.mode-btn {
  background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:8px 14px; border-radius:12px; cursor:pointer; font-weight:700; transition: all .18s; font-size:13px;
}
.mode-btn.active { color:#041024; background: linear-gradient(90deg, var(--neon-a), var(--neon-b)); box-shadow: var(--accent-glow); transform:translateY(-3px); }

/* top bar: q meta / progress / timer */
.topbar { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
.qmeta { display:flex; gap:12px; align-items:center; min-width:260px; }
.subject { padding:6px 10px; border-radius:10px; font-weight:800; color:#041024; background: linear-gradient(90deg,var(--neon-a),var(--neon-b)); box-shadow: var(--accent-glow); font-size:13px; }
.qcount { color:var(--muted); font-weight:600; font-size:13px; }
.progress { flex:1; height:12px; background: rgba(255,255,255,0.04); border-radius:999px; overflow:hidden; margin:0 6px; border:1px solid rgba(255,255,255,0.02); }
.progress-inner { height:100%; width:0%; background:linear-gradient(90deg,var(--neon-a),var(--neon-b)); transition:width .28s ease; box-shadow: 0 6px 18px rgba(126,241,255,0.06);}
.timer { min-width:170px; text-align:right; color: var(--neon-a); font-weight:800; }

/* question area */
.question-area { margin-top:6px; }
.question-card {
  border-radius:12px; padding:20px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border: 1px solid rgba(255,255,255,0.02); box-shadow: 0 18px 50px rgba(0,0,0,0.6);
  transition: transform .28s cubic-bezier(.2,.9,.2,1), opacity .18s;
}
.question-text { font-size:18px; line-height:1.5; color:#fff; margin-bottom:16px; }

/* options grid */
.options { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
.opt {
  display:flex; gap:12px; align-items:flex-start; cursor:pointer; padding:14px; border-radius:12px;
  background: linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.35)); border:1px solid rgba(255,255,255,0.03);
  transition: transform .12s, box-shadow .12s, border-color .12s, background .12s;
}
.opt:hover { transform:translateY(-6px); box-shadow: 0 14px 36px rgba(0,0,0,0.6); }
.opt .letter { width:46px; height:46px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:900; color:var(--muted); background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02); }
.opt .text { font-size:15px; color:#f7f9fb; line-height:1.35; }

/* selected / correct / wrong states */
.opt.selected { border-color: rgba(126,241,255,0.16); background: linear-gradient(90deg, rgba(126,241,255,0.06), rgba(179,124,255,0.04)); box-shadow: 0 12px 32px rgba(126,241,255,0.04); }
.opt.correct { background: linear-gradient(90deg, rgba(0,255,158,0.08), rgba(0,255,158,0.03)); border-color: rgba(0,255,158,0.12); box-shadow: 0 12px 30px rgba(0,255,158,0.06); }
.opt.wrong { background: linear-gradient(90deg, rgba(255,77,109,0.08), rgba(255,77,109,0.03)); border-color: rgba(255,77,109,0.12); box-shadow: 0 12px 30px rgba(255,77,109,0.06); }
.opt.disabled { opacity:0.95; cursor:default; transform:none; }

.explanation { display:none; margin-top:12px; padding:12px; border-radius:10px; background: rgba(255,255,255,0.02); color:var(--muted); font-size:14px; line-height:1.45; }

/* nav row */
.nav-row { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:14px; }
.left-nav { display:flex; gap:10px; align-items:center; }
.btn { padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--muted); cursor:pointer; font-weight:700; transition:all .12s; }
.btn:hover { transform:translateY(-3px); color:#fff; border-color: rgba(255,255,255,0.08); }
.btn.primary { background: linear-gradient(90deg,var(--neon-a),var(--neon-c)); color:#041024; border:none; box-shadow: var(--accent-glow); }

/* side column */
.side { display:flex; flex-direction:column; gap:14px; }
.panel { padding:12px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.02); box-shadow: var(--shadow); }
.small { color:var(--muted); font-size:13px; }
.grid { display:grid; grid-template-columns: repeat(5,1fr); gap:8px; margin-top:10px; }
.cell { height:42px; border-radius:8px; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.02); color:var(--muted); cursor:pointer; border:1px solid rgba(255,255,255,0.02); font-weight:700; }
.cell.visited { background: linear-gradient(90deg,var(--neon-a),var(--neon-b)); color:#041024; box-shadow: var(--accent-glow); }
.cell.marked { outline: 2px dashed rgba(255,255,255,0.04); }

/* result bars */
.result-bars { display:flex; gap:10px; justify-content:space-around; margin-top:12px; }
.result-bar { width:64px; border-radius:8px; background: rgba(255,255,255,0.03); padding:8px; text-align:center; }
.result-bar .val { font-weight:900; color:var(--neon-a); margin-top:8px; }

/* footer small */
.footer { grid-column:1/-1; margin-top:12px; text-align:center; color:var(--muted); font-size:13px; }

/* responsive */
@media (max-width: 980px) {
  .container { grid-template-columns: 1fr; padding:12px; }
  .side { order:2; }
}
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <div class="brand">
      <div class="logo">VS</div>
      <div>
        <div class="title">CEE AI — Neon Cyberpunk</div>
        <div class="subtitle">200 MCQs • Single-question view • Global timer • Keyboard controls</div>
      </div>
    </div>

    <div>
      <button id="saveBtn" class="btn">Save</button>
      <button id="resumeBtn" class="btn">Resume</button>
      <button id="resetBtn" class="btn">Reset</button>
    </div>
  </div>

  <!-- Left: main -->
  <div class="card">
    <div class="modes">
      <button class="mode-btn" data-mode="past">Past Year</button>
      <button class="mode-btn" data-mode="mock">Mock Test</button>
      <button class="mode-btn" data-mode="probable">Probable Qs</button>
      <button class="mode-btn active" data-mode="mixed">Mixed</button>
    </div>

    <div class="topbar">
      <div class="qmeta">
        <div id="subjectBadge" class="subject">Mixed</div>
        <div class="qcount" id="qCount">Q 0 / 200</div>
      </div>
      <div class="progress"><div id="progressInner" class="progress-inner"></div></div>
      <div class="timer" id="timer">--:--:--</div>
    </div>

    <div id="questionArea" class="question-area">
      <div class="question-card">
        <div class="question-text">Click a test mode to begin your CEE practice test.</div>
      </div>
    </div>

    <div class="nav-row">
      <div class="left-nav">
        <button id="prevBtn" class="btn">◀ Prev</button>
        <button id="nextBtn" class="btn">Next ▶</button>
        <button id="markBtn" class="btn">Mark</button>
        <button id="jumpBtn" class="btn">Jump</button>
      </div>
      <div>
        <button id="submitBtn" class="btn primary">Submit Test</button>
      </div>
    </div>
  </div>

  <!-- Right: side column -->
  <div class="side">
    <div class="panel">
      <div class="small">Question Grid</div>
      <div id="gridWrap" class="grid"></div>
    </div>

    <div class="panel">
      <div class="small">Summary</div>
      <div style="display:flex; gap:12px; margin-top:10px;">
        <div style="flex:1">
          <div class="small">Score</div>
          <div style="font-size:20px; font-weight:900" id="scoreView">0</div>
        </div>
        <div style="flex:1">
          <div class="small">Marked</div>
          <div style="font-size:20px; font-weight:900" id="markedView">0</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="small">Subject Breakdown</div>
      <div class="result-bars">
        <div class="result-bar"><div>Physics</div><div class="val" id="phyVal">0</div></div>
        <div class="result-bar"><div>Chem</div><div class="val" id="chemVal">0</div></div>
        <div class="result-bar"><div>Bio</div><div class="val" id="bioVal">0</div></div>
        <div class="result-bar"><div>GK</div><div class="val" id="gkVal">0</div></div>
      </div>
    </div>

    <div class="panel">
      <div class="small">Tools</div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="downloadBtn" class="btn">Download JSON</button>
        <button id="prefetchBtn" class="btn">Warm Buffer</button>
      </div>
    </div>
  </div>

  <div class="footer">Made with ❤️ for CEE aspirants — Neon Cyberpunk theme by VisionS</div>
</div>

<!-- small audio elements -->
<audio id="soundCorrect" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YcAAAAA="></audio>
<audio id="soundWrong" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YcAAAAA="></audio>

<script>
/* =========================================================
   Neon Cyberpunk Frontend Logic
   - Single-file: fetch from your Worker, render questions,
     manage timer, keyboard, save/resume, prefetch, navigation.
   ========================================================= */

/* ---------------- CONFIG ---------------- */
const WORKER_URL = "https://rapid-truth-3395.visionsyt99.workers.dev/"; // <- your worker
const TOTAL_QUESTIONS = 200;            // change if needed
const GLOBAL_SECONDS = 3 * 60 * 60;    // 3 hours default
const PREFETCH_COUNT = 2;              // how many ahead to fetch
const SAVE_KEY = "cee_neon_state_v1";

/* ---------------- STATE ---------------- */
let state = {
  mode: "mixed",
  timerSeconds: GLOBAL_SECONDS,
  current: 0,
  questions: Array(TOTAL_QUESTIONS).fill(null),
  answers: Array(TOTAL_QUESTIONS).fill(null),
  visited: Array(TOTAL_QUESTIONS).fill(false),
  marked: Array(TOTAL_QUESTIONS).fill(false),
  score: 0,
  subjectScores: { Physics:0, Chemistry:0, Biology:0, GK:0 }
};
let timerInterval = null;
let isFetching = {}; // index->bool
let soundEnabled = true;

/* ---------------- HELPERS ---------------- */
const $ = id => document.getElementById(id);
function qAll(sel){ return Array.from(document.querySelectorAll(sel)); }
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function pad(n, len=2){ return String(n).padStart(len,'0'); }
function fmtTime(s){
  if(s < 0) s = 0;
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  return `${pad(h)}:${pad(m)}:${pad(sec)}`;
}
function safeParse(objOrStr){
  if(!objOrStr) return null;
  if(typeof objOrStr === "object") return objOrStr;
  try{ return JSON.parse(objOrStr); } catch(e){
    const m = String(objOrStr).match(/\{[\s\S]*\}/);
    if(m) try{ return JSON.parse(m[0]); }catch(e2){ return null; }
    return null;
  }
}

/* ---------------- UI RENDER ---------------- */
function renderHeader(){
  $("qCount").textContent = `Q ${state.current+1} / ${TOTAL_QUESTIONS}`;
  const percent = Math.round((state.current / TOTAL_QUESTIONS) * 100);
  $("progressInner").style.width = `${percent}%`;
  $("timer").textContent = fmtTime(state.timerSeconds);
  $("scoreView").textContent = state.score;
  $("markedView").textContent = state.marked.filter(Boolean).length;
  $("phyVal").textContent = state.subjectScores.Physics;
  $("chemVal").textContent = state.subjectScores.Chemistry;
  $("bioVal").textContent = state.subjectScores.Biology;
  $("gkVal").textContent = state.subjectScores.GK;
}

function buildGrid(){
  const wrap = $("gridWrap");
  wrap.innerHTML = "";
  for(let i=0;i<TOTAL_QUESTIONS;i++){
    const cell = document.createElement("div");
    cell.className = "cell" + (state.visited[i] ? " visited" : "") + (state.marked[i] ? " marked" : "");
    cell.textContent = i+1;
    cell.title = `Go to Q ${i+1}`;
    cell.addEventListener("click", ()=> goTo(i));
    wrap.appendChild(cell);
  }
}

/* render a single question (if null, show loading) */
function renderQuestion(index){
  state.current = index = clamp(index,0,TOTAL_QUESTIONS-1);
  renderHeader();

  const area = $("questionArea");
  const q = state.questions[index];

  // update subject badge
  $("subjectBadge").textContent = q && q.subject ? q.subject : capitalize(state.mode);

  if(!q){
    area.innerHTML = `<div class="question-card"><div class="question-text">Loading question ${index+1}...</div></div>`;
    return;
  }

  // build options markup
  const answered = state.answers[index] !== null;
  let optionsHTML = "";
  for(let i=0;i<4;i++){
    const letter = String.fromCharCode(65 + i);
    const optText = q.options[i] || ("Option " + letter);
    let classes = "opt";
    if(answered){
      if(i === q.correct) classes += " correct";
      if(state.answers[index] === i && i !== q.correct) classes += " wrong";
      classes += " disabled";
    }
    optionsHTML += `<div class="${classes}" data-opt="${i}" tabindex="0">
      <div class="letter">${letter}</div>
      <div class="text">${escapeHtml(optText)}</div>
    </div>`;
  }

  area.innerHTML = `
    <div class="question-card" id="card_${index}">
      <div class="question-text">${escapeHtml(q.question)}</div>
      <div class="options">${optionsHTML}</div>
      <div class="explanation" id="explain_${index}">${escapeHtml(q.explanation || '')}</div>
    </div>
  `;

  // attach handlers
  const optionEls = area.querySelectorAll(".opt");
  optionEls.forEach(el => {
    el.addEventListener("click", () => {
      const idx = Number(el.getAttribute("data-opt"));
      if(state.answers[index] !== null) return;
      submitAnswer(index, idx);
    });
    el.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" || e.key === " ") { e.preventDefault(); el.click(); }
    });
  });

  // show explanation if answered
  if(state.answers[index] !== null){
    const expl = $(`explain_${index}`);
    if(expl) expl.style.display = "block";
  }

  state.visited[index] = true;
  buildGrid();
  renderHeader();
}

/* escape */
function escapeHtml(s){
  if(s === null || s === undefined) return "";
  return String(s).replace(/[&<>"'`]/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;'})[m]; });
}
function capitalize(s){ if(!s) return ''; return s[0].toUpperCase()+s.slice(1); }

/* ---------------- NAVIGATION ---------------- */
function goTo(index){
  index = clamp(index,0,TOTAL_QUESTIONS-1);
  state.current = index;
  saveStateDebounced();
  if(state.questions[index]) {
    renderQuestion(index);
    prefetch();
  } else {
    renderQuestion(index); // loading message
    fetchQuestion(index).then(()=> { renderQuestion(index); prefetch(); });
  }
}
function prev(){ goTo(state.current - 1); }
function next(){ goTo(state.current + 1); }

/* ---------------- ANSWERS ---------------- */
function submitAnswer(qIdx, chosenIdx){
  const q = state.questions[qIdx];
  if(!q) return;
  state.answers[qIdx] = chosenIdx;
  // scoring: if correct, increment; avoid double counting if user revisits (we only record first answer)
  if(chosenIdx === q.correct) {
    state.score += 1;
    state.subjectScores[q.subject] = (state.subjectScores[q.subject] || 0) + 1;
    if(soundEnabled) try{ $("soundCorrect").play(); }catch(e){}
  } else {
    if(soundEnabled) try{ $("soundWrong").play(); }catch(e){}
  }
  renderQuestion(qIdx);
  saveStateDebounced();
}

/* ---------------- MARK/FLAG ---------------- */
function toggleMark(){ state.marked[state.current] = !state.marked[state.current]; buildGrid(); renderHeader(); saveStateDebounced(); }
function toggleFlag(){ /* placeholder if needed */ saveStateDebounced(); }

/* ---------------- FETCH / PREFETCH ---------------- */
async function fetchQuestion(index, attempt=0){
  if(isFetching[index]) return;
  isFetching[index] = true;
  try {
    const payload = { mode: state.mode, index: index+1 };
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      cache: "no-store"
    });
    // parse
    let data = null;
    try { data = await res.json(); } catch(e){
      const txt = await res.text();
      data = safeParse(txt);
    }
    let q = safeParse(data);
    // fallback if invalid
    if(!q || !q.question || !Array.isArray(q.options) || q.options.length < 1){
      if(attempt < 2){
        // retry once after short delay
        await new Promise(r=>setTimeout(r, 800));
        return fetchQuestion(index, attempt+1);
      } else {
        q = {
          question: "Failed to generate question. Click Next.",
          options: ["Option A","Option B","Option C","Option D"],
          correct: 0,
          explanation: "AI/Worker returned invalid output. Check Worker logs or API key.",
          subject: "GK"
        };
      }
    } else {
      // normalize to exactly 4 options
      q.options = q.options.slice(0,4);
      while(q.options.length < 4) q.options.push("Option");
      // sanitize subject
      const allowed = ["Physics","Chemistry","Biology","GK"];
      if(!q.subject || !allowed.includes(q.subject)) {
        const s = String(q.subject||"").toLowerCase();
        if(s.includes("phys")) q.subject = "Physics";
        else if(s.includes("chem")) q.subject = "Chemistry";
        else if(s.includes("bio")) q.subject = "Biology";
        else q.subject = "GK";
      }
    }
    state.questions[index] = q;
  } catch (err) {
    console.error("Fetch question error:", err);
    state.questions[index] = {
      question: "Worker/AI error. Click Next.",
      options: ["A","B","C","D"],
      correct: 0,
      explanation: "Network/Worker error: " + (err && err.message ? err.message : "unknown"),
      subject: "GK"
    };
  } finally {
    isFetching[index] = false;
  }
}

/* load window-sized buffer ahead */
function prefetch(){
  for(let i=1;i<=PREFETCH_COUNT;i++){
    const idx = state.current + i;
    if(idx < TOTAL_QUESTIONS && !state.questions[idx] && !isFetching[idx]) {
      fetchQuestion(idx);
    }
  }
}

/* warm buffer across whole test start */
function warmBuffer(){
  for(let i=0;i<Math.min(6, TOTAL_QUESTIONS); i++){
    if(!state.questions[i]) fetchQuestion(i);
  }
  alert("Prefetch started for first questions.");
}

/* ---------------- TIMER ---------------- */
function startTimer(){
  if(timerInterval) return;
  timerInterval = setInterval(() => {
    state.timerSeconds -= 1;
    if(state.timerSeconds <= 0){
      clearInterval(timerInterval);
      alert("Time's up. Auto submitting...");
      submitTest();
    }
    renderHeader();
    saveStateDebounced();
  }, 1000);
}

/* ---------------- SUBMIT / RESULT ---------------- */
function submitTest(){
  // show result summary
  clearInterval(timerInterval);
  const correct = state.score;
  const total = TOTAL_QUESTIONS;
  const area = $("questionArea");
  area.innerHTML = `
    <div class="question-card">
      <div style="text-align:center">
        <h2 style="margin:6px 0 6px 0">Test Completed</h2>
        <div style="font-size:22px; color:var(--neon-a); font-weight:900">${correct} / ${total}</div>
        <div style="margin-top:8px; color:var(--muted)">Subject breakdown below</div>
      </div>
      <div style="display:flex; gap:12px; justify-content:center; margin-top:16px;">
        <div class="result-bar"><div>Physics</div><div class="val">${state.subjectScores.Physics}</div></div>
        <div class="result-bar"><div>Chemistry</div><div class="val">${state.subjectScores.Chemistry}</div></div>
        <div class="result-bar"><div>Biology</div><div class="val">${state.subjectScores.Biology}</div></div>
        <div class="result-bar"><div>GK</div><div class="val">${state.subjectScores.GK}</div></div>
      </div>
      <div style="text-align:center; margin-top:16px">
        <button class="btn primary" id="downloadReport">Download Report</button>
      </div>
    </div>
  `;
  $("downloadReport").addEventListener("click", ()=> {
    const payload = {
      meta: { date: new Date().toISOString(), mode: state.mode, total },
      score: { correct, total },
      subjectScores: state.subjectScores,
      answers: state.answers,
      questions: state.questions.map((q,i)=> q ? { index:i+1, question:q.question, options:q.options, correct:q.correct, subject:q.subject, chosen: state.answers[i] } : null)
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "cee_report.json"; a.click(); a.remove(); URL.revokeObjectURL(url);
  });
}

/* ---------------- SAVE / LOAD ---------------- */
function saveState(){
  try {
    const copy = {
      mode: state.mode, timerSeconds: state.timerSeconds, current: state.current,
      questions: state.questions, answers: state.answers, visited: state.visited,
      marked: state.marked, score: state.score, subjectScores: state.subjectScores
    };
    localStorage.setItem(SAVE_KEY, JSON.stringify(copy));
    alert("Progress saved locally.");
  } catch(e){ console.warn("save failed", e); alert("Save failed."); }
}
let saveTimer = null;
function saveStateDebounced(){
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(saveState, 700);
}
function loadState(){
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return false;
    const p = JSON.parse(raw);
    state.mode = p.mode ?? state.mode;
    state.timerSeconds = typeof p.timerSeconds === "number" ? p.timerSeconds : state.timerSeconds;
    state.current = typeof p.current === "number" ? p.current : state.current;
    state.questions = p.questions ?? state.questions;
    state.answers = p.answers ?? state.answers;
    state.visited = p.visited ?? state.visited;
    state.marked = p.marked ?? state.marked;
    state.score = p.score ?? state.score;
    state.subjectScores = p.subjectScores ?? state.subjectScores;
    return true;
  } catch(e){ console.warn("load failed", e); return false; }
}

/* ---------------- KEYBOARD ---------------- */
document.addEventListener("keydown", (e)=>{
  if(e.key === "ArrowRight"){ next(); startTimer(); }
  else if(e.key === "ArrowLeft"){ prev(); startTimer(); }
  else if(["a","A"].includes(e.key)){ chooseLetter(0); }
  else if(["b","B"].includes(e.key)){ chooseLetter(1); }
  else if(["c","C"].includes(e.key)){ chooseLetter(2); }
  else if(["d","D"].includes(e.key)){ chooseLetter(3); }
  else if(e.key === "Enter"){ if(state.answers[state.current] !== null) next(); }
});
function chooseLetter(i){ if(state.answers[state.current] !== null) return; submitAnswer(state.current, i); }

/* ---------------- BIND UI ---------------- */
qAll(".mode-btn").forEach(btn => {
  btn.addEventListener("click", ()=>{
    qAll(".mode-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    state.mode = btn.getAttribute("data-mode") || "mixed";
    state.current = 0;
    saveStateDebounced();
    goTo(0);
    startTimer();
    warmBuffer();
  });
});
$("prevBtn").addEventListener("click", ()=>{ prev(); startTimer(); });
$("nextBtn").addEventListener("click", ()=>{ next(); startTimer(); });
$("markBtn").addEventListener("click", ()=> toggleMark());
$("jumpBtn").addEventListener("click", ()=> {
  const n = prompt("Jump to question number (1 - " + TOTAL_QUESTIONS + ")");
  const k = Number(n);
  if(Number.isInteger(k) && k >=1 && k <= TOTAL_QUESTIONS) goTo(k-1);
});
$("submitBtn").addEventListener("click", ()=> {
  if(confirm("Submit the test now?")) submitTest();
});
$("saveBtn").addEventListener("click", ()=> saveState());
$("resumeBtn").addEventListener("click", ()=> {
  if(loadState()){ alert("Loaded saved progress"); buildGrid(); renderHeader(); goTo(state.current); startTimer(); } else alert("No saved progress found");
});
$("resetBtn").addEventListener("click", ()=> {
  if(confirm("Reset all progress?")) { localStorage.removeItem(SAVE_KEY); location.reload(); }
});
$("downloadBtn").addEventListener("click", ()=> {
  const payload = { date: new Date().toISOString(), mode: state.mode, answers: state.answers, questions: state.questions };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
  const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href=url; a.download="cee_export.json"; a.click(); a.remove(); URL.revokeObjectURL(url);
});
$("prefetchBtn").addEventListener("click", ()=> warmBuffer());

/* ---------------- INIT ---------------- */
(function init(){
  // initial UI
  buildGrid();
  renderHeader();
  renderQuestion(0);

  // if saved state exists, offer to restore
  const raw = localStorage.getItem(SAVE_KEY);
  if(raw){
    if(confirm("Saved progress found. Restore?")) {
      loadState();
      buildGrid();
      renderHeader();
      goTo(state.current);
      startTimer();
    }
  }
  // warm some initial questions
  warmBuffer();
})();

/* ---------------- UTILITY: buildGrid wrapper ---------------- */
function buildGrid(){ const wrap = $("gridWrap"); wrap.innerHTML=""; for(let i=0;i<TOTAL_QUESTIONS;i++){ const cell=document.createElement("div"); cell.className="cell"+(state.visited[i]?" visited":"")+(state.marked[i]?" marked":""); cell.textContent=i+1; cell.title=`Go to Q ${i+1}`; cell.addEventListener("click", ()=> goTo(i)); wrap.appendChild(cell);} }

/* ---------------- END ---------------- */
</script>
</body>
</html>
