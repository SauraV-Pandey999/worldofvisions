<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI CEE Exam Platform</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons (for flags, etc.) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* --- Custom Styles --- */
        :root {
            --bg-dark: #111827; /* gray-900 */
            --bg-medium: #1F2937; /* gray-800 */
            --bg-light: #374151; /* gray-700 */
            --text-primary: #F9FAFB; /* gray-100 */
            --text-secondary: #9CA3AF; /* gray-400 */
            --neon-blue: #0ea5e9; /* sky-500 */
            --neon-pink: #ec4899; /* pink-500 */
            --neon-green: #22c55e; /* green-500 */
            --neon-red: #ef4444; /* red-500 */
            --neon-yellow: #eab308; /* yellow-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-medium);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--bg-light);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4B5563; /* gray-600 */
        }

        /* --- Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes score-up {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes bar-grow {
            from { width: 0%; }
            to { /* width is set inline */ }
        }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        .fade-out { animation: fadeOut 0.3s ease-in; }
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--bg-light);
            border-top-color: var(--neon-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .skeleton {
            background-color: var(--bg-light);
            border-radius: 0.5rem;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* --- Question Nav Grid --- */
        #question-nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 0.5rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 0.5rem;
            background-color: var(--bg-medium);
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            border: 1px solid var(--bg-light);
        }
        .nav-item:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.3); /* neon-blue */
            color: var(--text-primary);
            border-color: var(--neon-blue);
        }
        .nav-item.current {
            background-color: var(--neon-blue);
            color: white;
            border-color: var(--neon-blue);
            box-shadow: 0 0 15px var(--neon-blue);
        }
        .nav-item.visited {
            background-color: #4B5563; /* gray-600 */
            color: var(--text-primary);
        }
        .nav-item.answered {
            background-color: var(--neon-green);
            color: white;
            border-color: var(--neon-green);
        }
        /* Status icons on nav items */
        .nav-item .icon-status {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-item .icon-status i {
            font-size: 12px;
            color: white;
        }
        .nav-item .icon-flag {
            background-color: var(--neon-pink);
        }
        .nav-item .icon-mark {
            background-color: var(--neon-yellow);
        }

        /* --- Question Card --- */
        .option-card {
            border: 2px solid var(--bg-light);
            transition: all 0.2s ease;
        }
        .option-card:hover {
            border-color: var(--neon-blue);
            background-color: rgba(14, 165, 233, 0.1);
        }
        .option-card.selected {
            border-color: var(--neon-blue);
            background-color: rgba(14, 165, 233, 0.2);
            box-shadow: 0 0 10px var(--neon-blue);
        }
        .option-card.correct {
            border-color: var(--neon-green);
            background-color: rgba(34, 197, 94, 0.15);
        }
        .option-card.incorrect {
            border-color: var(--neon-red);
            background-color: rgba(239, 68, 68, 0.15);
        }
        
        /* Explanation Box */
        .explanation-box {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .explanation-box.visible {
            max-height: 500px; /* arbitrary large value */
        }
        
        /* --- Buttons --- */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: 2px solid transparent;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .btn-primary {
            background-image: linear-gradient(to right, var(--neon-blue), var(--neon-pink));
            color: white;
        }
        .btn-primary:hover {
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.5), 0 0 20px rgba(236, 72, 153, 0.5);
        }
        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-primary);
            border-color: var(--bg-light);
        }
        .btn-secondary:hover {
            background-color: #4B5563; /* gray-600 */
        }
        .btn-flag.active {
            background-color: var(--neon-pink);
            color: white;
            border-color: var(--neon-pink);
            box-shadow: 0 0 10px var(--neon-pink);
        }
        .btn-mark.active {
            background-color: var(--neon-yellow);
            color: #111827;
            border-color: var(--neon-yellow);
            box-shadow: 0 0 10px var(--neon-yellow);
        }

        /* --- Toast Notifications --- */
        #toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            background-color: var(--bg-medium);
            color: var(--text-primary);
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            border-left: 4px solid var(--neon-blue);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease;
            transition: opacity 0.3s ease;
        }
        .toast.success { border-color: var(--neon-green); }
        .toast.error { border-color: var(--neon-red); }
        .toast.warning { border-color: var(--neon-yellow); }
        .toast.fading-out { opacity: 0; }

        /* --- Result Page --- */
        #result-score {
            font-size: 5rem;
            font-weight: 800;
            animation: score-up 0.5s ease-out;
            background: linear-gradient(to right, var(--neon-blue), var(--neon-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .chart-bar-bg {
            background-color: var(--bg-light);
            border-radius: 0.25rem;
            overflow: hidden;
        }
        .chart-bar {
            height: 1.5rem;
            border-radius: 0.25rem;
            background-image: linear-gradient(to right, var(--neon-blue), var(--neon-green));
            animation: bar-grow 1s ease-out;
            transition: width 0.5s ease;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 h-screen overflow-hidden">

    <!-- ===== Main App Container ===== -->
    <div id="app-container" class="h-full">

        <!-- ===== Loading View ===== -->
        <div id="loading-view" class="h-full flex flex-col items-center justify-center gap-6">
            <div class="spinner"></div>
            <h2 class="text-2xl font-semibold text-gray-300">Preparing Your Exam...</h2>
            <p class="text-gray-400">Fetching questions from AI. Please wait.</p>
        </div>

        <!-- ===== Exam View ===== -->
        <div id="exam-view" class="h-full flex flex-col hidden">
            <!-- Header -->
            <header class="flex-shrink-0 bg-gray-800 border-b border-gray-700 shadow-lg">
                <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                    <!-- Left: Exam Mode -->
                    <div class="flex items-center gap-3">
                        <span class="text-xl font-bold bg-gradient-to-r from-sky-500 to-pink-500 text-transparent bg-clip-text">AI CEE Exam</span>
                        <span id="exam-mode-badge" class="px-3 py-1 bg-sky-600 text-white text-sm font-semibold rounded-full uppercase">Mock</span>
                    </div>
                    
                    <!-- Middle: Progress Bar -->
                    <div class="w-1/2 hidden md:block">
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-gradient-to-r from-sky-500 to-pink-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div id="progress-text" class="text-center text-sm text-gray-400 mt-1">0 / 200 Answered</div>
                    </div>
                    
                    <!-- Right: Timer -->
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2 text-sky-400">
                            <i class="ph-fill ph-timer text-2xl"></i>
                            <span id="timer-display" class="text-xl font-semibold tabular-nums">03:00:00</span>
                        </div>
                        <button id="submit-btn" class="btn btn-primary">
                            <i class="ph-fill ph-check-circle"></i>
                            <span>Submit</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Content (Nav + Question) -->
            <main class="flex-1 flex overflow-hidden">
                
                <!-- Left Panel: Question Navigation -->
                <aside id="question-nav-panel" class="w-1/4 h-full bg-gray-800 border-r border-gray-700 p-4 overflow-y-auto">
                    <h3 class="text-lg font-semibold mb-4 text-gray-200">Question Navigation</h3>
                    <div id="question-nav-grid">
                        <!-- Nav items will be injected by JS -->
                    </div>
                </aside>

                <!-- Right Panel: Question Card -->
                <section id="question-panel" class="flex-1 h-full p-6 md:p-10 lg:p-12 overflow-y-auto">
                    <div id="question-card-container" class="max-w-4xl mx-auto">
                        
                        <!-- Skeleton Loader for Question -->
                        <div id="question-skeleton" class="hidden space-y-8">
                            <div class="skeleton h-8 w-3/4"></div>
                            <div class="space-y-4">
                                <div class="skeleton h-16 w-full"></div>
                                <div class="skeleton h-16 w-full"></div>
                                <div class="skeleton h-16 w-full"></div>
                                <div class="skeleton h-16 w-full"></div>
                            </div>
                        </div>
                        
                        <!-- Actual Question Content -->
                        <div id="question-content">
                            <!-- Question Header -->
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-semibold">
                                    <span id="question-number" class="text-sky-400"></span>
                                    <span id="question-subject" class="ml-2 px-3 py-1 bg-gray-700 text-sky-300 text-sm font-medium rounded-full"></span>
                                </h2>
                                <div class="flex gap-2">
                                    <button id="flag-btn" class="btn btn-secondary btn-flag">
                                        <i class="ph-fill ph-flag"></i>
                                        <span class="hidden md:inline">Flag</span>
                                    </button>
                                    <button id="mark-btn" class="btn btn-secondary btn-mark">
                                        <i class="ph-fill ph-bookmark-simple"></i>
                                        <span class="hidden md:inline">Mark for Review</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Question Text -->
                            <p id="question-text" class="text-xl text-gray-200 leading-relaxed mb-8" style="white-space: pre-wrap;"></p>

                            <!-- Options -->
                            <div id="options-container" class="space-y-4 mb-8">
                                <!-- Options will be injected by JS -->
                            </div>

                            <!-- Explanation (Collapsible) -->
                            <div id="explanation-container" class="explanation-box">
                                <h4 class="text-lg font-semibold text-green-400 mb-2">Detailed Explanation</h4>
                                <div class="p-4 bg-gray-800 border border-gray-700 rounded-lg">
                                    <p id="explanation-text" class="text-gray-300 leading-relaxed" style="white-space: pre-wrap;"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Footer Navigation -->
                        <footer class="mt-12 pt-6 border-t border-gray-700 flex justify-between items-center">
                            <button id="prev-btn" class="btn btn-secondary">
                                <i class="ph-fill ph-arrow-left"></i>
                                <span>Previous</span>
                            </button>
                            <button id="next-btn" class="btn btn-secondary">
                                <span>Next</span>
                                <i class="ph-fill ph-arrow-right"></i>
                            </button>
                        </footer>
                    </div>
                </section>
            </main>
        </div>

        <!-- ===== Result View ===== -->
        <div id="result-view" class="h-full p-6 md:p-12 overflow-y-auto hidden">
            <div class="max-w-5xl mx-auto">
                <h1 class="text-4xl font-bold text-center mb-4">Exam Result</h1>
                
                <!-- Score Summary -->
                <div class="text-center mb-12">
                    <p class="text-2xl text-gray-400 mb-2">Your Final Score</p>
                    <div id="result-score" class="tabular-nums">0</div>
                    <p id="result-summary-text" class="text-xl text-gray-300 mt-2"></p>
                </div>

                <!-- Subject-wise Chart -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl mb-12">
                    <h3 class="text-2xl font-semibold mb-6">Subject-wise Performance</h3>
                    <div id="subject-charts" class="space-y-4">
                        <!-- Charts injected by JS -->
                    </div>
                </div>

                <!-- Full Question Review -->
                <div>
                    <h3 class="text-2xl font-semibold mb-6">Full Question Review</h3>
                    <div id="review-container" class="space-y-8">
                        <!-- Review questions injected by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ===== Toast Container ===== -->
    <div id="toast-container"></div>
    
    <!-- ===== JavaScript Logic ===== -->
    <script type="module">
        // =================================================================================
        // !! The URL has been updated with your deployed worker !!
        // =================================================================================

        // === CONFIGURATION ===
        const WORKER_URL = 'https://rapid-truth-3395.visionsyt99.workers.dev/'; // <-- This is your deployed URL
        const TOTAL_QUESTIONS = 200;
        const EXAM_DURATION_SECONDS = 3 * 60 * 60; // 3 hours
        const QUESTIONS_PER_BATCH = 10; // How many questions to fetch from the AI at once
        const PREFETCH_BUFFER_INDEX = 5; // Start prefetching next batch when user reaches this index in current batch
        
        // === STATE ===
        const state = {
            currentView: 'loading',
            currentQuestionIndex: 0,
            examMode: 'mock',
            questions: new Array(TOTAL_QUESTIONS).fill(null),
            userAnswers: new Array(TOTAL_QUESTIONS).fill(null),
            questionStates: new Array(TOTAL_QUESTIONS).fill(0).map(() => ({
                visited: false,
                answered: false,
                flagged: false,
                marked: false,
            })),
            timerHandle: null,
            secondsRemaining: EXAM_DURATION_SECONDS,
            isSubmitting: false,
            fetchedBatchMarkers: new Set(),
        };

        // === DOM ELEMENTS ===
        const $ = (selector) => document.querySelector(selector);
        const dom = {
            loadingView: $('#loading-view'),
            examView: $('#exam-view'),
            resultView: $('#result-view'),
            examModeBadge: $('#exam-mode-badge'),
            progressBar: $('#progress-bar'),
            progressText: $('#progress-text'),
            timerDisplay: $('#timer-display'),
            submitBtn: $('#submit-btn'),
            questionNavGrid: $('#question-nav-grid'),
            questionPanel: $('#question-panel'),
            questionCardContainer: $('#question-card-container'),
            questionSkeleton: $('#question-skeleton'),
            questionContent: $('#question-content'),
            questionNumber: $('#question-number'),
            questionSubject: $('#question-subject'),
            questionText: $('#question-text'),
            optionsContainer: $('#options-container'),
            explanationContainer: $('#explanation-container'),
            explanationText: $('#explanation-text'),
            prevBtn: $('#prev-btn'),
            nextBtn: $('#next-btn'),
            flagBtn: $('#flag-btn'),
            markBtn: $('#mark-btn'),
            toastContainer: $('#toast-container'),
            resultScore: $('#result-score'),
            resultSummaryText: $('#result-summary-text'),
            subjectCharts: $('#subject-charts'),
            reviewContainer: $('#review-container'),
        };

        // === CORE LOGIC ===

        /**
         * Initializes the application
         */
        async function init() {
            console.log('Initializing Exam Platform...');
            // Setup keyboard listeners
            document.addEventListener('keydown', handleKeyDown);

            // Setup button listeners
            dom.submitBtn.addEventListener('click', () => confirmSubmit());
            dom.prevBtn.addEventListener('click', () => navigateQuestion('prev'));
            dom.nextBtn.addEventListener('click', () => navigateQuestion('next'));
            dom.flagBtn.addEventListener('click', toggleFlag);
            dom.markBtn.addEventListener('click', toggleMark);
            
            // Build the question nav
            renderQuestionNav();

            // Start fetching the first batch of questions
            await fetchQuestionBatch(0);

            // Once first batch is loaded, show the exam
            if (state.questions[0]) {
                updateView('exam');
                renderQuestion(0);
                startTimer();
                // Start prefetching the next batch
                fetchQuestionBatch(QUESTIONS_PER_BATCH);
            } else {
                // Handle critical fetch failure
                updateView('loading');
                dom.loadingView.innerHTML = `
                    <i class="ph-fill ph-wifi-slash text-5xl text-red-500"></i>
                    <h2 class="text-2xl font-semibold text-red-400">Failed to load exam</h2>
                    <p class="text-gray-400">Could not connect to the AI server. Please check your connection and refresh.</p>
                `;
                showToast('Failed to load initial questions.', 'error');
            }
        }

        /**
         * Fetches a batch of questions from the AI worker
         * @param {number} startIndex - The starting index for the batch
         */
        async function fetchQuestionBatch(startIndex) {
            if (startIndex >= TOTAL_QUESTIONS || state.fetchedBatchMarkers.has(startIndex)) {
                return; // Already fetched or out of bounds
            }
            
            console.log(`Fetching questions from index ${startIndex}...`);
            state.fetchedBatchMarkers.add(startIndex);

            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requestType: 'getQuestions',
                        mode: state.examMode,
                        startIndex: startIndex,
                        count: QUESTIONS_PER_BATCH,
                    }),
                });

                if (!response.ok) {
                    throw new Error(`Worker request failed with status ${response.status}`);
                }

                const newQuestions = await response.json();

                if (!Array.isArray(newQuestions) || newQuestions.length === 0) {
                    throw new Error('Invalid data received from AI');
                }

                // Populate the main questions array
                newQuestions.forEach((q, i) => {
                    const index = startIndex + i;
                    if (index < TOTAL_QUESTIONS) {
                        state.questions[index] = q;
                    }
                });

                console.log(`Successfully fetched batch ${startIndex}`);
                
                // If the user is currently viewing a question that was just fetched, re-render it
                if (state.currentQuestionIndex >= startIndex && state.currentQuestionIndex < startIndex + QUESTIONS_PER_BATCH) {
                    renderQuestion(state.currentQuestionIndex, true); // force re-render
                }

            } catch (error) {
                console.error(`Failed to fetch batch ${startIndex}:`, error);
                showToast(`Error fetching questions (Batch ${startIndex}). Retrying...`, 'error');
                state.fetchedBatchMarkers.delete(startIndex); // Allow retry
                // Simple retry logic
                setTimeout(() => fetchQuestionBatch(startIndex), 5000);
            }
        }

        /**
         * Renders a specific question
         * @param {number} index - The question index to render
         * @param {boolean} [force=false] - Force re-render even if index is same
         */
        function renderQuestion(index, force = false) {
            if (index < 0 || index >= TOTAL_QUESTIONS || state.isSubmitting) return;
            if (index === state.currentQuestionIndex && !force) return;

            // --- Animation ---
            dom.questionCardContainer.classList.add('fade-out');
            
            setTimeout(() => {
                state.currentQuestionIndex = index;
                const questionData = state.questions[index];

                if (questionData) {
                    // --- Question data is available ---
                    dom.questionContent.classList.remove('hidden');
                    dom.questionSkeleton.classList.add('hidden');

                    dom.questionNumber.textContent = `Question ${index + 1}`;
                    dom.questionSubject.textContent = questionData.subject;
                    dom.questionText.textContent = questionData.question;

                    // Render options
                    dom.optionsContainer.innerHTML = '';
                    const userAnswerIndex = state.userAnswers[index];
                    const hasAnswered = userAnswerIndex !== null;

                    questionData.options.forEach((option, i) => {
                        const optionEl = document.createElement('div');
                        optionEl.className = 'option-card p-4 rounded-lg cursor-pointer flex items-start gap-4';
                        optionEl.innerHTML = `
                            <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center border-2 border-gray-500 rounded-full font-semibold text-gray-300">${String.fromCharCode(65 + i)}</span>
                            <span class="flex-1 text-lg text-gray-200" style="white-space: pre-wrap;">${option}</span>
                        `;
                        
                        optionEl.addEventListener('click', () => handleOptionSelect(index, i));
                        
                        // Apply styles if already answered
                        if (hasAnswered) {
                            if (i === questionData.correct) {
                                optionEl.classList.add('correct');
                            } else if (i === userAnswerIndex) {
                                optionEl.classList.add('incorrect');
                            }
                            if (i === userAnswerIndex) {
                                optionEl.classList.add('selected');
                            }
                        }

                        dom.optionsContainer.appendChild(optionEl);
                    });

                    // Handle explanation visibility
                    if (hasAnswered) {
                        dom.explanationText.textContent = questionData.explanation;
                        dom.explanationContainer.classList.add('visible');
                    } else {
                        dom.explanationContainer.classList.remove('visible');
                    }

                } else {
                    // --- Question data not fetched yet, show skeleton ---
                    dom.questionContent.classList.add('hidden');
                    dom.questionSkeleton.classList.remove('hidden');
                    
                    // Trigger fetch for this batch if not already triggered
                    const batchStartIndex = Math.floor(index / QUESTIONS_PER_BATCH) * QUESTIONS_PER_BATCH;
                    fetchQuestionBatch(batchStartIndex);
                }

                // Update states
                state.questionStates[index].visited = true;
                
                // Update UI elements
                updateButtonStates();
                updateQuestionNav();
                updateProgressBar();

                // --- Prefetching Logic ---
                const batchIndex = index % QUESTIONS_PER_BATCH;
                if (batchIndex >= PREFETCH_BUFFER_INDEX) {
                    const nextBatchStartIndex = Math.floor(index / QUESTIONS_PER_BATCH) * QUESTIONS_PER_BATCH + QUESTIONS_PER_BATCH;
                    fetchQuestionBatch(nextBatchStartIndex);
                }
                
                // --- Animation ---
                dom.questionCardContainer.classList.remove('fade-out');
                dom.questionCardContainer.classList.add('fade-in');
                
                // Scroll panel to top
                dom.questionPanel.scrollTop = 0;

            }, 300); // Match fadeOut duration
        }

        /**
         * Handles the selection of an answer option
         * @param {number} questionIndex
         * @param {number} optionIndex
         */
        function handleOptionSelect(questionIndex, optionIndex) {
            if (state.userAnswers[questionIndex] !== null) {
                showToast('Answer already submitted for this question.', 'warning');
                return; // Already answered
            }

            state.userAnswers[questionIndex] = optionIndex;
            state.questionStates[questionIndex].answered = true;

            const questionData = state.questions[questionIndex];
            const isCorrect = optionIndex === questionData.correct;
            
            // Re-render the options to show feedback
            renderQuestion(questionIndex, true); 

            showToast(isCorrect ? 'Correct!' : 'Incorrect.', isCorrect ? 'success' : 'error');

            // Update nav and progress
            updateQuestionNav();
            updateProgressBar();
        }

        /**
         * Handles keyboard navigation and actions
         * @param {Event} e
         */
        function handleKeyDown(e) {
            if (state.currentView !== 'exam') return;

            // Prevent default for arrow keys to stop scrolling
            if (['ArrowLeft', 'ArrowRight', '1', '2', '3', '4', 'f', 'F'].includes(e.key)) {
                e.preventDefault();
            }

            switch (e.key) {
                case 'ArrowLeft':
                    navigateQuestion('prev');
                    break;
                case 'ArrowRight':
                    navigateQuestion('next');
                    break;
                case '1':
                case 'a':
                case 'A':
                    handleOptionSelect(state.currentQuestionIndex, 0);
                    break;
                case '2':
                case 'b':
                case 'B':
                    handleOptionSelect(state.currentQuestionIndex, 1);
                    break;
                case '3':
                case 'c':
                case 'C':
                    handleOptionSelect(state.currentQuestionIndex, 2);
                    break;
                case '4':
                case 'd':
                case 'D':
                    handleOptionSelect(state.currentQuestionIndex, 3);
                    break;
                case 'f':
                case 'F':
                    toggleFlag();
                    break;
            }
        }

        /**
         * Navigates to the next or previous question
         * @param {'next' | 'prev'} direction
         */
        function navigateQuestion(direction) {
            let newIndex = state.currentQuestionIndex;
            if (direction === 'next') {
                newIndex = Math.min(TOTAL_QUESTIONS - 1, newIndex + 1);
            } else {
                newIndex = Math.max(0, newIndex - 1);
            }
            if (newIndex !== state.currentQuestionIndex) {
                renderQuestion(newIndex);
            }
        }

        // === UI UPDATE FUNCTIONS ===

        /**
         * Switches the main view
         * @param {'loading' | 'exam' | 'result'} viewName
         */
        function updateView(viewName) {
            state.currentView = viewName;
            dom.loadingView.classList.add('hidden');
            dom.examView.classList.add('hidden');
            dom.resultView.classList.add('hidden');
            
            if (viewName === 'loading') dom.loadingView.classList.remove('hidden');
            if (viewName === 'exam') dom.examView.classList.remove('hidden');
            if (viewName === 'result') dom.resultView.classList.remove('hidden');
        }

        /**
         * Updates the progress bar and text
         */
        function updateProgressBar() {
            const answeredCount = state.questionStates.filter(s => s.answered).length;
            const percentage = (answeredCount / TOTAL_QUESTIONS) * 100;
            dom.progressBar.style.width = `${percentage}%`;
            dom.progressText.textContent = `${answeredCount} / ${TOTAL_QUESTIONS} Answered`;
        }

        /**
         * Renders the entire 200-question navigation grid
         */
        function renderQuestionNav() {
            let navHtml = '';
            for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                navHtml += `<div class="nav-item" data-index="${i}">${i + 1}</div>`;
            }
            dom.questionNavGrid.innerHTML = navHtml;
            
            // Add event listeners
            dom.questionNavGrid.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    renderQuestion(index);
                });
            });
            
            updateQuestionNav(); // Apply initial styles
        }

        /**
         * Updates the styles of the question navigation items
         */
        function updateQuestionNav() {
            dom.questionNavGrid.querySelectorAll('.nav-item').forEach((item, i) => {
                const qState = state.questionStates[i];
                item.className = 'nav-item'; // Reset classes
                
                if (qState.answered) item.classList.add('answered');
                else if (qState.visited) item.classList.add('visited');
                
                if (i === state.currentQuestionIndex) item.classList.add('current');
                
                // Handle icons
                let iconHtml = '';
                if (qState.flagged) {
                    iconHtml += `<span class="icon-status icon-flag"><i class="ph-fill ph-flag"></i></span>`;
                }
                if (qState.marked) {
                    iconHtml += `<span class="icon-status icon-mark"><i class="ph-fill ph-bookmark-simple"></i></span>`;
                }
                item.innerHTML = `${i + 1}${iconHtml}`;
            });
        }

        /**
         * Updates the state of the prev/next/flag/mark buttons
         */
        function updateButtonStates() {
            // Prev/Next
            dom.prevBtn.disabled = state.currentQuestionIndex === 0;
            dom.nextBtn.disabled = state.currentQuestionIndex === TOTAL_QUESTIONS - 1;
            dom.prevBtn.classList.toggle('opacity-50', dom.prevBtn.disabled);
            dom.nextBtn.classList.toggle('opacity-50', dom.nextBtn.disabled);
            
            // Flag/Mark
            const qState = state.questionStates[state.currentQuestionIndex];
            dom.flagBtn.classList.toggle('active', qState.flagged);
            dom.markBtn.classList.toggle('active', qState.marked);
        }

        /**
         * Toggles the 'flagged' state for the current question
         */
        function toggleFlag() {
            const index = state.currentQuestionIndex;
            const qState = state.questionStates[index];
            qState.flagged = !qState.flagged;
            showToast(qState.flagged ? 'Question flagged' : 'Flag removed', 'info');
            updateQuestionNav();
            updateButtonStates();
        }

        /**
         * Toggles the 'marked' state for the current question
         */
        function toggleMark() {
            const index = state.currentQuestionIndex;
            const qState = state.questionStates[index];
            qState.marked = !qState.marked;
            showToast(qState.marked ? 'Question marked for review' : 'Mark removed', 'info');
            updateQuestionNav();
            updateButtonStates();
        }

        // === TIMER LOGIC ===

        /**
         * Starts the exam timer
         */
        function startTimer() {
            // Set initial timer display
            dom.timerDisplay.textContent = formatTime(state.secondsRemaining);
            
            state.timerHandle = setInterval(() => {
                state.secondsRemaining--;
                dom.timerDisplay.textContent = formatTime(state.secondsRemaining);

                // Timer warnings
                if (state.secondsRemaining === 300) { // 5 minutes
                    showToast('5 minutes remaining!', 'warning');
                    dom.timerDisplay.classList.add('text-yellow-400');
                } else if (state.secondsRemaining === 60) { // 1 minute
                    showToast('1 minute remaining!', 'error');
                    dom.timerDisplay.classList.remove('text-yellow-400');
                    dom.timerDisplay.classList.add('text-red-500', 'animate-pulse');
                }

                // Time's up!
                if (state.secondsRemaining <= 0) {
                    clearInterval(state.timerHandle);
                    dom.timerDisplay.textContent = '00:00:00';
                    showToast("Time's up! Submitting your exam.", 'error');
                    submitExam();
                }
            }, 1000);
        }

        /**
         * Formats seconds into HH:MM:SS
         * @param {number} totalSeconds
         * @returns {string}
         */
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return [hours, minutes, seconds].map(v => v.toString().padStart(2, '0')).join(':');
        }

        // === SUBMISSION & RESULT LOGIC ===

        /**
         * Asks for confirmation before submitting
         */
        function confirmSubmit() {
            // A custom modal would be better, but `confirm` is blocked.
            // We will use a custom toast notification as a pseudo-confirmation.
            if (state.isSubmitting) return;

            showToast('Click Submit again to confirm.', 'warning');
            dom.submitBtn.removeEventListener('click', confirmSubmit);
            dom.submitBtn.addEventListener('click', submitExam);

            // Revert if not clicked again in 5 seconds
            setTimeout(() => {
                if (!state.isSubmitting) {
                    dom.submitBtn.removeEventListener('click', submitExam);
                    dom.submitBtn.addEventListener('click', confirmSubmit);
                }
            }, 5000);
        }

        /**
         * Submits the exam and calculates results
         */
        function submitExam() {
            if (state.isSubmitting) return;
            state.isSubmitting = true;
            
            console.log('Submitting exam...');
            clearInterval(state.timerHandle);
            
            // Calculate score
            let score = 0;
            let attempted = 0;
            const subjectStats = { Physics: { correct: 0, total: 0 }, Chemistry: { correct: 0, total: 0 }, Biology: { correct: 0, total: 0 }, GK: { correct: 0, total: 0 } };

            state.questions.forEach((q, i) => {
                if (!q) return; // Skip unanswered/unloaded questions
                
                const userAnswer = state.userAnswers[i];
                const subject = q.subject || 'GK'; // Default to GK if subject missing
                
                if (!subjectStats[subject]) { // Handle potential unknown subjects
                    subjectStats[subject] = { correct: 0, total: 0 };
                }

                subjectStats[subject].total++;

                if (userAnswer !== null) {
                    attempted++;
                    if (userAnswer === q.correct) {
                        score++;
                        subjectStats[subject].correct++;
                    }
                }
            });

            console.log('Score:', score);
            console.log('Subject Stats:', subjectStats);

            // Render the result page
            renderResultPage(score, attempted, subjectStats);
            updateView('result');
        }

        /**
         * Renders the final result page
         * @param {number} score
         * @param {number} attempted
         * @param {object} subjectStats
         */
        function renderResultPage(score, attempted, subjectStats) {
            // Animate score
            let currentScore = 0;
            const scoreInterval = setInterval(() => {
                if (score === 0) {
                    dom.resultScore.textContent = 0;
                    clearInterval(scoreInterval);
                    return;
                }
                currentScore++;
                dom.resultScore.textContent = currentScore;
                if (currentScore >= score) clearInterval(scoreInterval);
            }, 20);

            dom.resultSummaryText.textContent = `You scored ${score} out of ${TOTAL_QUESTIONS} (${attempted} attempted)`;

            // Render subject charts
            dom.subjectCharts.innerHTML = '';
            for (const [subject, stats] of Object.entries(subjectStats)) {
                if (stats.total === 0) continue;
                const percentage = (stats.correct / stats.total) * 100 || 0;
                const chartEl = document.createElement('div');
                chartEl.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-lg">${subject}</span>
                        <span class="text-gray-300">${stats.correct} / ${stats.total} (${percentage.toFixed(0)}%)</span>
                    </div>
                    <div class="chart-bar-bg">
                        <div class="chart-bar" style="width: ${percentage}%"></div>
                    </div>
                `;
                dom.subjectCharts.appendChild(chartEl);
            }

            // Render full review
            dom.reviewContainer.innerHTML = '';
            state.questions.forEach((q, i) => {
                if (!q) return; // Skip unloaded
                
                const userAnswer = state.userAnswers[i];
                const isCorrect = userAnswer === q.correct;
                const isAttempted = userAnswer !== null;
                
                const reviewEl = document.createElement('div');
                reviewEl.className = 'p-6 bg-gray-800 rounded-lg border border-gray-700';
                
                let optionHtml = '';
                q.options.forEach((opt, j) => {
                    let classes = 'p-3 rounded border';
                    if (j === q.correct) {
                        classes += ' bg-green-900 border-green-700'; // Correct answer
                    } else if (j === userAnswer && !isCorrect) {
                        classes += ' bg-red-900 border-red-700'; // Wrong user answer
                    } else {
                        classes += ' bg-gray-700 border-gray-600';
                    }
                    
                    optionHtml += `<li class="${classes}">${String.fromCharCode(65 + j)}. ${opt}</li>`;
                });
                
                reviewEl.innerHTML = `
                    <h4 class="text-xl font-semibold mb-3">
                        <span class="text-sky-400">Q.${i + 1}</span> (${q.subject})
                    </h4>
                    <p class="text-lg text-gray-200 mb-4" style="white-space: pre-wrap;">${q.question}</p>
                    <ul class="space-y-2 mb-4">${optionHtml}</ul>
                    <div class="mt-4">
                        <h5 class="font-semibold text-green-400 mb-2">Explanation:</h5>
                        <p class="text-gray-300" style="white-space: pre-wrap;">${q.explanation}</p>
                    </div>
                `;
                dom.reviewContainer.appendChild(reviewEl);
            });
        }

        // === UTILITY FUNCTIONS ===

        /**
         * Shows a toast notification
         * @param {string} message
         * @param {'info' | 'success' | 'warning' | 'error'} type
         */
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            dom.toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('fading-out');
                toast.addEventListener('transitionend', () => {
                    toast.remove();
                });
            }, 3000);
        }

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', init);
        
    </script>
</body>
</html>
