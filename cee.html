<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI CEE Exam Simulator</title>
    
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons for UI elements -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- === KaTeX for high-quality mathematical rendering === -->
    <!-- CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" xintegrity="sha384-KiWOvVjnN8qwKMvhIqsNOHQGOqDssIIFsgjO+FSOgUy8ALSPS2/0tDREB3jSCl8z" crossorigin="anonymous">
    <!-- Main JS -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" xintegrity="sha384-hIoBPJpTadx5Gvj2adM6iB5oI3P3Q3u/wGfN2MstP/fIRwR1x/ZclVbB8wBHiLIm" crossorigin="anonymous"></script>
    <!-- Auto-rendering extension (for scanning HTML content) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" xintegrity="sha384-43gviWU0YVjaDtb/Gf1J+D/jV88FfG4zoSGe0YiOdCstrPWPcyqcMfqE+4eCBYC/." crossorigin="anonymous"></script>

    <style>
        /* --- Root Variables for a consistent dark theme --- */
        :root {
            --bg-dark: #0F172A; /* slate-900 */
            --bg-medium: #1E293B; /* slate-800 */
            --bg-light: #334155; /* slate-700 */
            --text-primary: #F8FAFC; /* slate-50 */
            --text-secondary: #94A3B8; /* slate-400 */
            --neon-blue: #0ea5e9; /* sky-500 */
            --neon-pink: #ec4899; /* pink-500 */
            --neon-green: #22c55e; /* green-500 */
            --neon-red: #ef4444; /* red-500 */
            --neon-yellow: #eab308; /* yellow-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden; /* Control the main scrollbar */
        }
        
        /* KaTeX Font Fix: Ensures math is slightly larger for readability */
        .katex {
            font-size: 1.2rem;
            line-height: 1.5;
        }

        /* --- Scrollbar Styling --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-medium); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--bg-light); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes score-up { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .spinner { width: 48px; height: 48px; border: 4px solid var(--bg-light); border-top-color: var(--neon-blue); border-radius: 50%; animation: spin 0.8s linear infinite; }
        .skeleton { background-color: var(--bg-light); border-radius: 0.5rem; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* --- Mode Selection Cards --- */
        .mode-card {
            background-color: var(--bg-medium);
            border: 2px solid var(--bg-light);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5), 0 0 15px var(--neon-blue);
            border-color: var(--neon-blue);
        }

        /* --- Question Navigation Grid --- */
        #question-nav-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); 
            gap: 0.5rem; 
        }
        .nav-item { 
            display: flex; align-items: center; justify-content: center; 
            width: 40px; height: 40px; border-radius: 0.5rem; 
            background-color: var(--bg-medium); color: var(--text-secondary); 
            font-weight: 600; cursor: pointer; transition: all 0.2s ease; 
            position: relative; border: 1px solid var(--bg-light); 
        }
        .nav-item:hover { transform: scale(1.05); box-shadow: 0 0 10px rgba(14, 165, 233, 0.5); color: var(--text-primary); border-color: var(--neon-blue); }
        .nav-item.current { background-color: var(--neon-blue); color: white; border-color: var(--neon-blue); box-shadow: 0 0 15px var(--neon-blue); }
        .nav-item.visited { background-color: #334155; color: var(--text-primary); }
        .nav-item.answered { background-color: var(--neon-green); color: white; border-color: var(--neon-green); }
        .nav-item .icon-status { position: absolute; top: -6px; right: -6px; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .nav-item .icon-status i { font-size: 10px; color: white; }
        .nav-item .icon-flag { background-color: var(--neon-pink); }
        .nav-item .icon-mark { background-color: var(--neon-yellow); }

        /* --- Option Cards --- */
        .option-card { border: 2px solid var(--bg-light); transition: all 0.2s ease; }
        .option-card:hover:not(.selected):not(.correct):not(.incorrect) { border-color: var(--neon-blue); background-color: rgba(14, 165, 233, 0.1); }
        .option-card.selected { border-color: var(--neon-blue); background-color: rgba(14, 165, 233, 0.2); box-shadow: 0 0 10px var(--neon-blue); }
        .option-card.correct { border-color: var(--neon-green); background-color: rgba(34, 197, 94, 0.15); }
        .option-card.incorrect { border-color: var(--neon-red); background-color: rgba(239, 68, 68, 0.15); }
        
        /* --- Explanation Box (Hidden until submitted) --- */
        .explanation-box { max-height: 0; overflow: hidden; transition: max-height 0.6s ease-out; }
        .explanation-box.visible { max-height: 1000px; /* Large enough to accommodate typical content */ }
        
        /* --- Buttons --- */
        .btn { padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 0.5rem; border: 2px solid transparent; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-image: linear-gradient(to right, var(--neon-blue), var(--neon-pink)); color: white; }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 0 20px rgba(14, 165, 233, 0.6), 0 0 20px rgba(236, 72, 153, 0.6); }
        .btn-secondary { background-color: var(--bg-light); color: var(--text-primary); border-color: var(--bg-light); }
        .btn-secondary:hover:not(:disabled) { background-color: #475569; }
        .btn-flag.active { background-color: var(--neon-pink); color: white; border-color: var(--neon-pink); box-shadow: 0 0 10px var(--neon-pink); }
        .btn-mark.active { background-color: var(--neon-yellow); color: #1e293b; border-color: var(--neon-yellow); box-shadow: 0 0 10px var(--neon-yellow); }

        /* --- Result View Styling --- */
        #result-score { font-size: 6rem; font-weight: 800; animation: score-up 0.8s ease-out; background: linear-gradient(to right, var(--neon-blue), var(--neon-pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .chart-bar-bg { background-color: var(--bg-light); border-radius: 0.25rem; overflow: hidden; }
        .chart-bar { height: 1.5rem; border-radius: 0.25rem; background-image: linear-gradient(to right, var(--neon-blue), var(--neon-green)); transition: width 0.5s ease; }
        
    </style>
</head>

<body class="bg-slate-900 text-slate-50 h-screen">

    <!-- ===== Main App Container ===== -->
    <div id="app-container" class="h-full">

        <!-- ===== 1. Mode Selection View ===== -->
        <div id="mode-select-view" class="h-full flex flex-col items-center justify-center p-6 text-center">
            <div class="max-w-4xl">
                <h1 class="text-6xl font-extrabold mb-4 bg-gradient-to-r from-sky-400 to-pink-500 text-transparent bg-clip-text">AI CEE Exam Simulator</h1>
                <p class="text-xl text-slate-400 mb-12">Select an exam mode to begin your 3-hour practice test.</p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Probable Mode -->
                    <div class="mode-card p-8 rounded-xl" data-mode="probable">
                        <i class="ph-fill ph-target-shooter text-5xl text-sky-400 mb-4"></i>
                        <h3 class="text-3xl font-bold mb-2">Probable Topics</h3>
                        <p class="text-slate-400 text-sm">High-yield questions focusing on anticipated and highly frequent topics from the syllabus.</p>
                    </div>

                    <!-- Past Year Mode -->
                    <div class="mode-card p-8 rounded-xl" data-mode="past-year">
                        <i class="ph-fill ph-scroll text-5xl text-pink-400 mb-4"></i>
                        <h3 class="text-3xl font-bold mb-2">Past Year Pattern</h3>
                        <p class="text-slate-400 text-sm">Questions that strictly mimic the difficulty and distribution of previous CEE exam papers.</p>
                    </div>

                    <!-- Mixed Mode -->
                    <div class="mode-card p-8 rounded-xl" data-mode="mixed">
                        <i class="ph-fill ph-shuffle text-5xl text-green-400 mb-4"></i>
                        <h3 class="text-3xl font-bold mb-2">Mixed Mock Exam</h3>
                        <p class="text-slate-400 text-sm">A balanced general test covering the entire syllabus with varied difficulty, simulating a general mock.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== 2. Loading View ===== -->
        <div id="loading-view" class="h-full flex flex-col items-center justify-center gap-8 hidden">
            <div class="spinner"></div>
            <h2 class="text-3xl font-semibold text-slate-300">Preparing Your Exam...</h2>
            <p class="text-slate-400" id="loading-message">Fetching the first batch of 200 questions from AI. Please wait.</p>
        </div>

        <!-- ===== 3. Exam View (The Main Test Interface) ===== -->
        <div id="exam-view" class="h-full flex flex-col hidden">
            
            <!-- Header/Controls -->
            <header class="flex-shrink-0 bg-slate-800 border-b border-slate-700 shadow-xl">
                <div class="container mx-auto px-4 py-4 flex items-center justify-between">
                    <!-- Left: Exam Mode & Title -->
                    <div class="flex items-center gap-4">
                        <span class="text-2xl font-bold bg-gradient-to-r from-sky-500 to-pink-500 text-transparent bg-clip-text">CEE Simulator</span>
                        <span id="exam-mode-badge" class="px-3 py-1 bg-sky-600 text-white text-sm font-semibold rounded-full uppercase tracking-wider"></span>
                    </div>
                    
                    <!-- Middle: Progress Bar (Hidden on small screens) -->
                    <div class="w-1/2 hidden md:block">
                        <div class="w-full bg-slate-700 rounded-full h-3">
                            <div id="progress-bar" class="bg-gradient-to-r from-sky-500 to-pink-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div id="progress-text" class="text-center text-sm text-slate-400 mt-1">0 / 200 Answered</div>
                    </div>
                    
                    <!-- Right: Timer and Submit -->
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2 text-sky-400">
                            <i class="ph-fill ph-timer text-2xl"></i>
                            <span id="timer-display" class="text-2xl font-bold tabular-nums">03:00:00</span>
                        </div>
                        <button id="submit-btn" class="btn btn-primary">
                            <i class="ph-fill ph-check-circle"></i>
                            <span class="hidden sm:inline">Submit Exam</span>
                            <span class="inline sm:hidden">Submit</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Content (Nav + Question) -->
            <main class="flex-1 flex overflow-hidden">
                
                <!-- Left Panel: Question Navigation (Fixed Width) -->
                <aside id="question-nav-panel" class="w-1/5 max-w-xs h-full bg-slate-800 border-r border-slate-700 p-6 overflow-y-auto hidden lg:block">
                    <h3 class="text-lg font-semibold mb-4 text-slate-200">Question Navigation (200 Total)</h3>
                    <div id="question-nav-grid">
                        <!-- Nav items are injected here -->
                    </div>
                </aside>

                <!-- Right Panel: Question Card -->
                <section id="question-panel" class="flex-1 h-full p-6 md:p-10 overflow-y-auto">
                    <div id="question-card-container" class="max-w-4xl mx-auto">
                        
                        <!-- Skeleton Loader for smooth question loading -->
                        <div id="question-skeleton" class="hidden space-y-8">
                            <div class="skeleton h-10 w-3/4"></div>
                            <div class="space-y-4">
                                <div class="skeleton h-16 w-full"></div>
                                <div class="skeleton h-16 w-full"></div>
                                <div class="skeleton h-16 w-full"></div>
                                <div class="skeleton h-16 w-full"></div>
                            </div>
                        </div>
                        
                        <!-- Actual Question Content -->
                        <div id="question-content">
                            <!-- Question Header (Number, Subject, Action buttons) -->
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h2 class="text-3xl font-bold">
                                        <span id="question-number" class="text-sky-400">Q. 1</span>
                                    </h2>
                                    <span id="question-subject" class="mt-1 inline-block px-4 py-1 bg-slate-700 text-sky-300 text-base font-medium rounded-full"></span>
                                </div>
                                <div class="flex gap-3">
                                    <button id="flag-btn" class="btn btn-secondary btn-flag">
                                        <i class="ph-fill ph-flag text-lg"></i>
                                        <span class="hidden md:inline">Flag</span>
                                    </button>
                                    <button id="mark-btn" class="btn btn-secondary btn-mark">
                                        <i class="ph-fill ph-bookmark-simple text-lg"></i>
                                        <span class="hidden md:inline">Mark for Review</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Question Text container (where KaTeX magic happens) -->
                            <p id="question-text" class="text-xl text-slate-200 leading-relaxed mb-8" style="white-space: pre-wrap;"></p>

                            <!-- Options Container -->
                            <div id="options-container" class="space-y-4 mb-10">
                                <!-- Options are injected here -->
                            </div>

                            <!-- Explanation (Visible ONLY after submission) -->
                            <div id="explanation-container" class="explanation-box">
                                <h4 class="text-xl font-semibold text-green-400 mb-3 border-b border-green-800 pb-1">Detailed Explanation</h4>
                                <div class="p-4 bg-slate-800 border border-slate-700 rounded-lg shadow-inner">
                                    <p id="explanation-text" class="text-slate-300 leading-relaxed" style="white-space: pre-wrap;"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Footer Navigation -->
                        <footer class="mt-12 pt-6 border-t border-slate-700 flex justify-between items-center">
                            <button id="prev-btn" class="btn btn-secondary">
                                <i class="ph-fill ph-arrow-left"></i>
                                <span>Previous</span>
                            </button>
                            <button id="next-btn" class="btn btn-secondary">
                                <span>Next</span>
                                <i class="ph-fill ph-arrow-right"></i>
                            </button>
                        </footer>
                    </div>
                </section>
            </main>
        </div>

        <!-- ===== 4. Result View (Full Review after Submission) ===== -->
        <div id="result-view" class="h-full p-6 md:p-12 overflow-y-auto hidden">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-5xl font-bold text-center mb-4 text-sky-400">Exam Results & Review</h1>
                <p class="text-xl text-center text-slate-400 mb-12">Congratulations on completing the ${state.examMode} mock exam!</p>
                
                <!-- Score Summary -->
                <div class="text-center mb-12 bg-slate-800 p-8 rounded-xl shadow-2xl border border-slate-700">
                    <p class="text-2xl text-slate-400 mb-4 font-medium">Your Final Score</p>
                    <div id="result-score" class="tabular-nums">0</div>
                    <p id="result-summary-text" class="text-xl text-slate-300 mt-4"></p>
                </div>

                <!-- Subject-wise Analysis -->
                <div class="bg-slate-800 p-6 rounded-lg shadow-xl mb-12 border border-slate-700">
                    <h3 class="text-3xl font-semibold mb-6 text-pink-400">Subject-wise Performance Breakdown</h3>
                    <div id="subject-charts" class="space-y-6">
                        <!-- Charts injected by JS -->
                    </div>
                </div>

                <!-- Full Question Review Section -->
                <div>
                    <h3 class="text-3xl font-semibold mb-6 text-green-400">Detailed Review (All 200 Questions)</h3>
                    <div id="review-container" class="space-y-10">
                        <!-- Review questions injected by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ===== Toast Container for non-intrusive notifications ===== -->
    <div id="toast-container"></div>
    
    <!-- ===== Comprehensive JavaScript Logic (Uncompromised) ===== -->
    <script type="module">
        // =================================================================================
        // Configuration and Setup
        // =================================================================================
        const WORKER_URL = 'https://rapid-truth-3395.visionsyt99.workers.dev/'; 
        
        // --- CONFIGURATION CONSTANTS ---
        const TOTAL_QUESTIONS = 200;
        const EXAM_DURATION_SECONDS = 3 * 60 * 60; // 3 hours in seconds
        const QUESTIONS_PER_BATCH = 10; // Batch size for fetching from AI
        const PREFETCH_BUFFER_INDEX = 5; // Start fetching the next batch when we reach this index in the current batch
        
        // --- APPLICATION STATE ---
        const state = {
            currentView: 'mode-select',
            currentQuestionIndex: 0,
            examMode: null, 
            questions: new Array(TOTAL_QUESTIONS).fill(null), // Stores question data (200 slots)
            userAnswers: new Array(TOTAL_QUESTIONS).fill(null), // Stores user's selected option index (0-3)
            questionStates: new Array(TOTAL_QUESTIONS).fill(0).map(() => ({ // Tracks flags, marks, and visit status
                visited: false,
                answered: false,
                flagged: false,
                marked: false,
            })),
            timerHandle: null,
            secondsRemaining: EXAM_DURATION_SECONDS,
            isSubmitted: false, // Locks the exam after submission
            fetchedBatchMarkers: new Set(), // Tracks which 10-question batches have been requested
        };

        // --- DOM Elements Selector ---
        const $ = (selector) => document.querySelector(selector);
        const dom = {
            modeSelectView: $('#mode-select-view'),
            loadingView: $('#loading-view'),
            examView: $('#exam-view'),
            resultView: $('#result-view'),
            loadingMessage: $('#loading-message'),
            examModeBadge: $('#exam-mode-badge'),
            progressBar: $('#progress-bar'),
            progressText: $('#progress-text'),
            timerDisplay: $('#timer-display'),
            submitBtn: $('#submit-btn'),
            questionNavGrid: $('#question-nav-grid'),
            questionPanel: $('#question-panel'),
            questionCardContainer: $('#question-card-container'),
            questionSkeleton: $('#question-skeleton'),
            questionContent: $('#question-content'),
            questionNumber: $('#question-number'),
            questionSubject: $('#question-subject'),
            questionText: $('#question-text'),
            optionsContainer: $('#options-container'),
            explanationContainer: $('#explanation-container'),
            explanationText: $('#explanation-text'),
            prevBtn: $('#prev-btn'),
            nextBtn: $('#next-btn'),
            flagBtn: $('#flag-btn'),
            markBtn: $('#mark-btn'),
            toastContainer: $('#toast-container'),
            resultScore: $('#result-score'),
            resultSummaryText: $('#result-summary-text'),
            subjectCharts: $('#subject-charts'),
            reviewContainer: $('#review-container'),
        };

        // =================================================================================
        // KaTeX Math Rendering Utilities
        // =================================================================================

        /**
         * Renders LaTeX math expressions within a specified DOM element.
         * @param {HTMLElement} element - The root element to scan for LaTeX delimiters.
         */
        function renderMath(element = dom.questionContent) {
            if (window.renderMathInElement) {
                renderMathInElement(element, {
                    // Define standard LaTeX delimiters for auto-rendering
                    delimiters: [
                        {left: '$$', right: '$$', display: true},  // Block math
                        {left: '$', right: '$', display: false}, // Inline math
                        {left: '\\[', right: '\\]', display: true}, // Alternative block
                        {left: '\\(', right: '\\)', display: false} // Alternative inline
                    ],
                    throwOnError: false // Prevents app crash on bad LaTeX syntax
                });
            } else {
                console.warn("KaTeX library not fully loaded. Math rendering skipped.");
            }
        }
        
        // =================================================================================
        // Application Flow and Initialization
        // =================================================================================

        /**
         * Initializes the application and sets up event listeners.
         */
        function init() {
            console.log('Initializing AI CEE Exam Platform...');
            document.addEventListener('keydown', handleKeyDown);

            // 1. Setup mode selection listeners
            document.querySelectorAll('.mode-card').forEach(card => {
                card.addEventListener('click', () => startExam(card.dataset.mode));
            });

            // 2. Setup exam control buttons
            dom.submitBtn.addEventListener('click', () => confirmSubmit());
            dom.prevBtn.addEventListener('click', () => navigateQuestion('prev'));
            dom.nextBtn.addEventListener('click', () => navigateQuestion('next'));
            dom.flagBtn.addEventListener('click', toggleFlag);
            dom.markBtn.addEventListener('click', toggleMark);
            
            updateView('mode-select');
        }

        /**
         * Starts the exam after a mode is selected by the user.
         * @param {string} mode - 'probable', 'past-year', or 'mixed'.
         */
        async function startExam(mode) {
            state.examMode = mode;
            dom.examModeBadge.textContent = mode.toUpperCase().replace('-', ' ');
            updateView('loading');
            dom.loadingMessage.textContent = `Generating ${TOTAL_QUESTIONS} ${mode.toUpperCase().replace('-', ' ')} CEE questions...`;

            // Setup navigation grid for 200 questions
            renderQuestionNav();

            // Fetch the first batch to start the exam
            await fetchQuestionBatch(0);

            // Check if the initial load was successful
            if (state.questions[0]) {
                updateView('exam');
                renderQuestion(0);
                startTimer();
                // Immediately pre-fetch the next batch while the user answers Q1
                fetchQuestionBatch(QUESTIONS_PER_BATCH); 
            } else {
                // Handle failure to load initial batch gracefully
                updateView('loading');
                dom.loadingView.innerHTML = `
                    <i class="ph-fill ph-wifi-slash text-6xl text-red-500 mb-4"></i>
                    <h2 class="text-3xl font-bold text-red-400">Failed to Load Exam</h2>
                    <p class="text-slate-400 text-center max-w-md mt-2">The server could not generate the questions. Please check the network or retry.</p>
                    <button class="btn btn-primary mt-6" onclick="window.location.reload()">Retry Mode Selection</button>
                `;
                showToast('Initial question fetch failed. Check worker status.', 'error');
            }
        }


        // =================================================================================
        // Data Fetching and Question Management
        // =================================================================================

        /**
         * Fetches a batch of questions from the AI worker using the selected exam mode.
         * Implements a robust check to avoid duplicate requests.
         * @param {number} startIndex - The starting index of the batch (e.g., 0, 10, 20...).
         */
        async function fetchQuestionBatch(startIndex) {
            if (startIndex >= TOTAL_QUESTIONS || state.fetchedBatchMarkers.has(startIndex)) {
                return; // Already requested or index out of bounds
            }
            
            console.log(`Requesting batch starting at index ${startIndex} for mode: ${state.examMode}`);
            state.fetchedBatchMarkers.add(startIndex); // Mark as requested

            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    cache: 'no-store', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requestType: 'getQuestions',
                        mode: state.examMode, 
                        startIndex: startIndex,
                        count: QUESTIONS_PER_BATCH,
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error Response:", errorData);
                    throw new Error(errorData.message || `Worker request failed with status ${response.status}`);
                }

                const newQuestions = await response.json();

                if (!Array.isArray(newQuestions) || newQuestions.length === 0) {
                    throw new Error('Invalid data received from AI: empty or non-array response.');
                }

                // Inject new questions into the global state array
                newQuestions.forEach((q, i) => {
                    const index = startIndex + i;
                    if (index < TOTAL_QUESTIONS) {
                        state.questions[index] = q;
                    }
                });

                console.log(`Successfully received and stored batch starting at index ${startIndex}`);
                
                // If the user is currently waiting on a question that just loaded, re-render it
                if (state.currentQuestionIndex >= startIndex && state.currentQuestionIndex < startIndex + QUESTIONS_PER_BATCH) {
                    renderQuestion(state.currentQuestionIndex, true); 
                }

            } catch (error) {
                console.error(`CRITICAL: Failed to fetch batch ${startIndex}:`, error);
                showToast(`Error fetching questions: ${error.message}. Retrying...`, 'error');
                state.fetchedBatchMarkers.delete(startIndex); // Allow retry later
            }
        }

        /**
         * Renders the question UI for a specific index.
         * Handles loading state and pre-fetching logic.
         * @param {number} index - The question index to render (0-199).
         * @param {boolean} force - Force re-render even if index hasn't changed.
         */
        function renderQuestion(index, force = false) {
            if (state.isSubmitted) return; // Lock UI after submission
            if (index < 0 || index >= TOTAL_QUESTIONS) return;
            if (index === state.currentQuestionIndex && !force) return;

            dom.questionCardContainer.classList.add('opacity-0'); // Smooth transition
            
            setTimeout(() => {
                state.currentQuestionIndex = index;
                const questionData = state.questions[index];

                if (questionData) {
                    // Show actual content and hide skeleton
                    dom.questionContent.classList.remove('hidden');
                    dom.questionSkeleton.classList.add('hidden');

                    dom.questionNumber.textContent = `Q. ${index + 1}`;
                    dom.questionSubject.textContent = questionData.subject;
                    dom.questionText.innerHTML = questionData.question; // Use innerHTML for KaTeX processing

                    // Options Rendering
                    dom.optionsContainer.innerHTML = '';
                    const userAnswerIndex = state.userAnswers[index];
                    
                    questionData.options.forEach((option, i) => {
                        const optionEl = document.createElement('div');
                        optionEl.className = 'option-card p-4 rounded-lg cursor-pointer flex items-start gap-4';
                        optionEl.innerHTML = `
                            <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center border-2 border-slate-500 rounded-full font-semibold text-slate-300">${String.fromCharCode(65 + i)}</span>
                            <span class="flex-1 text-lg text-slate-200 option-text">${option}</span>
                        `;
                        
                        // Attach selection handler
                        optionEl.addEventListener('click', () => handleOptionSelect(index, i));
                        
                        // Apply 'selected' class if answered
                        if (i === userAnswerIndex) {
                            optionEl.classList.add('selected');
                        }

                        dom.optionsContainer.appendChild(optionEl);
                    });

                    // Explanation is ALWAYS hidden in the live exam view
                    dom.explanationContainer.classList.remove('visible');


                } else {
                    // Show skeleton and trigger fetch for the missing batch
                    dom.questionContent.classList.add('hidden');
                    dom.questionSkeleton.classList.remove('hidden');
                    const batchStartIndex = Math.floor(index / QUESTIONS_PER_BATCH) * QUESTIONS_PER_BATCH;
                    fetchQuestionBatch(batchStartIndex);
                }

                // Update state and UI controls
                state.questionStates[index].visited = true;
                updateButtonStates();
                updateQuestionNav();
                updateProgressBar();

                // Pre-fetch logic: Check if we are near the end of a loaded batch
                const batchIndex = index % QUESTIONS_PER_BATCH;
                if (batchIndex >= PREFETCH_BUFFER_INDEX) {
                    const nextBatchStartIndex = Math.floor(index / QUESTIONS_PER_BATCH) * QUESTIONS_PER_BATCH + QUESTIONS_PER_BATCH;
                    fetchQuestionBatch(nextBatchStartIndex);
                }
                
                // Final visual updates
                dom.questionCardContainer.classList.remove('opacity-0');
                dom.questionPanel.scrollTop = 0;
                
                // RENDER MATH FOR NEW CONTENT
                try {
                    renderMath();
                } catch (e) {
                    console.error("KaTeX rendering error during renderQuestion:", e);
                }

            }, 200); // Wait for transition out
        }

        /**
         * Handles the selection of an answer option.
         * @param {number} questionIndex - Index of the question.
         * @param {number} optionIndex - Index of the selected option.
         */
        function handleOptionSelect(questionIndex, optionIndex) {
            if (state.isSubmitted) return; 
            if (state.userAnswers[questionIndex] === optionIndex) {
                // If clicking the same option, de-select it
                state.userAnswers[questionIndex] = null;
                state.questionStates[questionIndex].answered = false;
            } else {
                // Otherwise, select the new option
                state.userAnswers[questionIndex] = optionIndex;
                state.questionStates[questionIndex].answered = true;
            }

            // Re-render to show the selection/deselection visually
            renderQuestion(questionIndex, true); 
        }

        /**
         * Navigates to the next or previous question.
         * @param {string} direction - 'next' or 'prev'.
         */
        function navigateQuestion(direction) {
            let newIndex = state.currentQuestionIndex;
            if (direction === 'next') {
                newIndex = Math.min(TOTAL_QUESTIONS - 1, newIndex + 1);
            } else {
                newIndex = Math.max(0, newIndex - 1);
            }
            if (newIndex !== state.currentQuestionIndex) {
                renderQuestion(newIndex);
            }
        }
        
        /**
         * Handles keyboard shortcuts for quick exam interaction.
         */
        function handleKeyDown(e) {
            if (state.currentView !== 'exam' || state.isSubmitted) return;

            const key = e.key.toLowerCase();
            // Prevent default behavior for keys that might scroll or trigger browser actions
            if (['arrowleft', 'arrowright', '1', '2', '3', '4', 'a', 'b', 'c', 'd', 'f', 'm'].includes(key)) {
                e.preventDefault();
            }

            switch (key) {
                case 'arrowleft': navigateQuestion('prev'); break;
                case 'arrowright': navigateQuestion('next'); break;
                // Option Selection via Number Keys (1-4) or Letter Keys (A-D)
                case '1': case 'a': handleOptionSelect(state.currentQuestionIndex, 0); break;
                case '2': case 'b': handleOptionSelect(state.currentQuestionIndex, 1); break;
                case '3': case 'c': handleOptionSelect(state.currentQuestionIndex, 2); break;
                case '4': case 'd': handleOptionSelect(state.currentQuestionIndex, 3); break;
                // Action Buttons
                case 'f': toggleFlag(); break;
                case 'm': toggleMark(); break;
            }
        }


        // =================================================================================
        // UI State and Helper Functions
        // =================================================================================

        /**
         * Switches the active view (Mode Select, Loading, Exam, Result).
         * @param {string} viewName 
         */
        function updateView(viewName) {
            state.currentView = viewName;
            dom.modeSelectView.classList.add('hidden');
            dom.loadingView.classList.add('hidden');
            dom.examView.classList.add('hidden');
            dom.resultView.classList.add('hidden');

            if (viewName === 'mode-select') dom.modeSelectView.classList.remove('hidden');
            else if (viewName === 'loading') dom.loadingView.classList.remove('hidden');
            else if (viewName === 'exam') dom.examView.classList.remove('hidden');
            else if (viewName === 'result') dom.resultView.classList.remove('hidden');
        }

        /**
         * Populates the 200 question navigation grid.
         */
        function renderQuestionNav() {
            let navHtml = '';
            for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                navHtml += `<div class="nav-item" data-index="${i}">${i + 1}</div>`;
            }
            dom.questionNavGrid.innerHTML = navHtml;
            dom.questionNavGrid.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    renderQuestion(index);
                });
            });
            updateQuestionNav();
        }
        
        /**
         * Updates the visual state of the question navigation grid items.
         */
        function updateQuestionNav() {
            dom.questionNavGrid.querySelectorAll('.nav-item').forEach((item, i) => {
                const qState = state.questionStates[i];
                // Reset classes
                item.className = 'nav-item'; 
                
                // Apply status classes
                if (qState.answered) item.classList.add('answered');
                else if (qState.visited) item.classList.add('visited');

                if (i === state.currentQuestionIndex) item.classList.add('current');
                
                // Handle status icons (Flagged/Marked)
                let iconHtml = '';
                if (qState.flagged) iconHtml += `<span class="icon-status icon-flag"><i class="ph-fill ph-flag"></i></span>`;
                if (qState.marked) iconHtml += `<span class="icon-status icon-mark"><i class="ph-fill ph-bookmark-simple"></i></span>`;
                item.innerHTML = `${i + 1}${iconHtml}`;
            });
        }

        /**
         * Updates the progress bar and text count.
         */
        function updateProgressBar() {
            const answeredCount = state.questionStates.filter(s => s.answered).length;
            const percentage = (answeredCount / TOTAL_QUESTIONS) * 100;
            dom.progressBar.style.width = `${percentage}%`;
            dom.progressText.textContent = `${answeredCount} / ${TOTAL_QUESTIONS} Answered`;
        }
        
        /**
         * Toggles the state of navigation buttons and action buttons (Flag/Mark).
         */
        function updateButtonStates() {
            dom.prevBtn.disabled = state.currentQuestionIndex === 0 || state.isSubmitted;
            dom.nextBtn.disabled = state.currentQuestionIndex === TOTAL_QUESTIONS - 1 || state.isSubmitted;
            
            const qState = state.questionStates[state.currentQuestionIndex];
            dom.flagBtn.classList.toggle('active', qState.flagged);
            dom.markBtn.classList.toggle('active', qState.marked);

            // Disable action buttons if submitted
            dom.flagBtn.disabled = state.isSubmitted;
            dom.markBtn.disabled = state.isSubmitted;
        }

        /**
         * Toggles the 'flagged' status for the current question.
         */
        function toggleFlag() {
            if (state.isSubmitted) return;
            const index = state.currentQuestionIndex;
            const qState = state.questionStates[index];
            qState.flagged = !qState.flagged;
            showToast(qState.flagged ? 'Question flagged' : 'Flag removed', 'info');
            updateQuestionNav();
            updateButtonStates();
        }

        /**
         * Toggles the 'marked' status for the current question.
         */
        function toggleMark() {
            if (state.isSubmitted) return;
            const index = state.currentQuestionIndex;
            const qState = state.questionStates[index];
            qState.marked = !qState.marked;
            showToast(qState.marked ? 'Question marked for review' : 'Mark removed', 'info');
            updateQuestionNav();
            updateButtonStates();
        }

        // =================================================================================
        // Timer Logic
        // =================================================================================

        /**
         * Starts the exam countdown timer.
         */
        function startTimer() {
            dom.timerDisplay.textContent = formatTime(state.secondsRemaining);
            state.timerHandle = setInterval(() => {
                state.secondsRemaining--;
                dom.timerDisplay.textContent = formatTime(state.secondsRemaining);
                
                // Timer Warnings
                if (state.secondsRemaining === 300) {
                    showToast('5 minutes remaining! Complete your answers.', 'warning');
                    dom.timerDisplay.classList.add('text-yellow-400');
                } else if (state.secondsRemaining === 60) {
                    showToast('1 minute remaining! Final countdown.', 'error');
                    dom.timerDisplay.classList.remove('text-yellow-400');
                    dom.timerDisplay.classList.add('text-red-500', 'animate-pulse');
                }
                
                if (state.secondsRemaining <= 0) {
                    clearInterval(state.timerHandle);
                    dom.timerDisplay.textContent = '00:00:00';
                    showToast("Time's up! The exam is automatically submitted.", 'error');
                    submitExam(true); // Auto-submit when time runs out
                }
            }, 1000);
        }

        /**
         * Formats seconds into HH:MM:SS string.
         */
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return [hours, minutes, seconds].map(v => v.toString().padStart(2, '0')).join(':');
        }

        // =================================================================================
        // Submission and Result Logic
        // =================================================================================

        /**
         * Displays a confirmation toast before final submission.
         */
        function confirmSubmit() {
            if (state.isSubmitted) return;
            showToast('Click "Submit Exam" again to confirm and end the test.', 'warning');
            
            // Temporarily replace the listener with the final submit function
            dom.submitBtn.removeEventListener('click', confirmSubmit);
            dom.submitBtn.addEventListener('click', () => submitExam(false));
            
            // Revert after 5 seconds if not submitted
            setTimeout(() => {
                if (!state.isSubmitted) {
                    dom.submitBtn.removeEventListener('click', submitExam);
                    dom.submitBtn.addEventListener('click', confirmSubmit);
                }
            }, 5000);
        }

        /**
         * Finalizes the exam, calculates the score, and renders the result view.
         */
        function submitExam() {
            if (state.isSubmitted) return;
            state.isSubmitted = true;
            console.log('Final exam submission...');
            clearInterval(state.timerHandle);
            
            // Ensure all UI elements are disabled
            dom.submitBtn.disabled = true;
            updateButtonStates();

            let score = 0;
            let attempted = 0;
            // Initialize subject tracking for all 4 required subjects
            const subjectStats = { Physics: { correct: 0, total: 0 }, Chemistry: { correct: 0, total: 0 }, Biology: { correct: 0, total: 0 }, GK: { correct: 0, total: 0 } };

            state.questions.forEach((q, i) => {
                // Only process questions that successfully loaded
                if (!q) return; 
                
                const userAnswer = state.userAnswers[i];
                const subject = q.subject || 'GK'; 
                
                // Safety check for subject initialization
                if (!subjectStats[subject]) subjectStats[subject] = { correct: 0, total: 0 };
                
                subjectStats[subject].total++;

                if (state.questionStates[i].answered) { 
                    attempted++;
                    // Check correctness
                    if (userAnswer === q.correct) {
                        score++;
                        subjectStats[subject].correct++;
                    }
                }
            });

            console.log(`Exam finalized. Score: ${score}/${TOTAL_QUESTIONS}`);
            renderResultPage(score, attempted, subjectStats);
            updateView('result');
            dom.questionNavPanel.classList.add('hidden'); // Hide the side panel on result view
        }

        /**
         * Renders the comprehensive result and review page.
         */
        function renderResultPage(score, attempted, subjectStats) {
            // --- 1. Score Counter Animation ---
            let currentScore = 0;
            const scoreInterval = setInterval(() => {
                if (score === 0) {
                    dom.resultScore.textContent = 0;
                    clearInterval(scoreInterval);
                    return;
                }
                currentScore++;
                dom.resultScore.textContent = currentScore;
                if (currentScore >= score) clearInterval(scoreInterval);
            }, 20); // Fast counting animation

            dom.resultSummaryText.textContent = `You scored ${score} out of ${TOTAL_QUESTIONS}. You attempted ${attempted} questions and had ${attempted - score} incorrect.`;

            // --- 2. Subject-wise Charts ---
            dom.subjectCharts.innerHTML = '';
            for (const [subject, stats] of Object.entries(subjectStats)) {
                if (stats.total === 0) continue;
                const percentage = (stats.correct / stats.total) * 100 || 0;
                const chartEl = document.createElement('div');
                chartEl.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-xl">${subject}</span>
                        <span class="text-slate-300 text-lg">${stats.correct} / ${stats.total} (${percentage.toFixed(1)}%)</span>
                    </div>
                    <div class="chart-bar-bg">
                        <div class="chart-bar" style="width: ${percentage}%"></div>
                    </div>
                `;
                dom.subjectCharts.appendChild(chartEl);
            }

            // --- 3. Full 200 Question Review ---
            dom.reviewContainer.innerHTML = '';
            state.questions.forEach((q, i) => {
                // Skip if question data failed to load
                if (!q) return; 

                const userAnswer = state.userAnswers[i];
                const isCorrect = userAnswer === q.correct;
                const isAttempted = state.questionStates[i].answered;
                const reviewEl = document.createElement('div');
                reviewEl.className = 'p-6 bg-slate-800 rounded-lg shadow-lg border border-slate-700';
                
                let statusText = isAttempted 
                    ? (isCorrect ? '<span class="text-green-400 font-bold"><i class="ph-fill ph-check"></i> CORRECT</span>' : '<span class="text-red-400 font-bold"><i class="ph-fill ph-x"></i> INCORRECT</span>')
                    : '<span class="text-yellow-400 font-bold"><i class="ph-fill ph-warning-circle"></i> NOT ATTEMPTED</span>';

                let optionHtml = '';
                q.options.forEach((opt, j) => {
                    let classes = 'p-3 rounded border text-lg';
                    if (j === q.correct) classes += ' bg-green-900 border-green-700 text-white font-semibold';
                    else if (j === userAnswer && !isCorrect) classes += ' bg-red-900 border-red-700 text-white font-semibold';
                    else classes += ' bg-slate-700 border-slate-600 text-slate-300';
                    
                    optionHtml += `<li class="${classes}">${String.fromCharCode(65 + j)}. ${opt}</li>`;
                });
                
                // Construct the full review card HTML
                reviewEl.innerHTML = `
                    <h4 class="text-2xl font-bold mb-4 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="text-sky-400">Q.${i + 1}</span> 
                            <span class="text-slate-400 text-lg">(${q.subject})</span>
                        </div>
                        ${statusText}
                    </h4>
                    <p class="text-xl text-slate-200 mb-6" style="white-space: pre-wrap;">${q.question}</p>
                    <ul class="space-y-3 mb-6">${optionHtml}</ul>
                    <div class="mt-4 pt-4 border-t border-slate-700">
                        <h5 class="font-bold text-xl text-green-400 mb-2">Detailed Solution:</h5>
                        <p class="text-slate-300 leading-relaxed" style="white-space: pre-wrap;">${q.explanation}</p>
                    </div>
                `;
                dom.reviewContainer.appendChild(reviewEl);

                // Render math for the newly injected review card
                renderMath(reviewEl);
            });
        }
        
        // =================================================================================
        // Toast Notification System
        // =================================================================================

        /**
         * Shows a non-intrusive toast notification.
         */
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            dom.toastContainer.appendChild(toast);
            
            // Fade out after 3 seconds
            setTimeout(() => {
                toast.classList.add('fading-out');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        // === INITIALIZATION ENTRY POINT ===
        document.addEventListener('DOMContentLoaded', init);
        
    </script>
</body>
</html>
