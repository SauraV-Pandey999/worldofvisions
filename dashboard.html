<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Vision_S â€” Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    /* =======================
       Root variables
    ======================== */
    :root{
      --bg-1:#0b1220;
      --glass: rgba(255,255,255,0.06);
      --glass-2: rgba(255,255,255,0.03);
      --neon-1: #6ee7b7;
      --neon-2: #60a5fa;
      --neon-3: #a78bfa;
      --accent: linear-gradient(90deg,var(--neon-1),var(--neon-2),var(--neon-3));
      --card-w: 940px;
      --max-level: 7;
      --font-primary: 'Poppins', sans-serif;
    }
    *{box-sizing:border-box;font-family:var(--font-primary); color:#e8f2ff; margin:0; padding:0;}
    html,body{height:100%; background: linear-gradient(120deg,#030417 0%,#0a0436 35%,#1a044b 100%); background-size:400% 400%; animation:bgMove 12s ease infinite;}
    @keyframes bgMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;}
    .card{width:100%;max-width:var(--card-w);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:28px;box-shadow:0 8px 40px rgba(0,0,0,0.6);position:relative;overflow:hidden;}
    
    /* Header */
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .brand{display:flex;gap:14px;align-items:center;}
    .logo{width:64px;height:64px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800;color:#04102a;box-shadow:0 10px 30px rgba(96,165,250,0.08);}
    .title{font-size:20px;font-weight:700;}
    .subtitle{font-size:13px;color:#bcd3ef;}
    .controls{display:flex;gap:10px;align-items:center;}
    .btn{padding:8px 12px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);color:inherit;cursor:pointer;transition: all 0.2s;}
    .btn:hover{transform:translateY(-3px); background:rgba(96,165,250,0.2);}
    .tag{font-size:12px;color:#bcd3ef;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);}
    
    /* Main layout */
    .main{display:flex;gap:22px;margin-top:20px;}
    .left{width:340px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));padding:18px;border-radius:12px;}
    .right{flex:1;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));}
    
    /* Profile & avatar */
    .profile-row{display:flex;gap:12px;align-items:center;margin-bottom:18px;}
    .avatar{width:72px;height:72px;border-radius:14px;background:linear-gradient(90deg,var(--neon-3),var(--neon-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#04102a;font-size:24px;overflow:hidden;}
    .avatar img{width:100%;height:100%;object-fit:cover;border-radius:14px;}
    .user-meta{display:flex;flex-direction:column;}
    .user-name{font-size:18px;font-weight:700;}
    .user-email{font-size:13px;color:#b9d0ef;}
    
    /* Streak */
    .streak{margin-top:14px;padding:12px;border-radius:10px;background:var(--glass-2);text-align:center;}
    .streak h4{margin:6px 0 0;font-size:14px;}
    .streak .count{font-weight:800;font-size:20px;margin-top:6px;}
    .hint{margin-top:12px;font-size:13px;color:#bcd3ef;}
    
    /* Progress */
    .progress-card{margin-top:18px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
    .level-row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .level-badge{padding:8px 14px;border-radius:999px;background:linear-gradient(90deg,#ffd47a,#d4af37);color:#241600;font-weight:800;}
    .level-name{font-weight:800;font-size:16px;}
    .progress-wrapper{margin-top:14px;}
    .progress-bar{height:18px;background:rgba(255,255,255,0.06);border-radius:999px;overflow:hidden;position:relative;}
    .progress-fill{height:100%;width:0%;border-radius:999px;background:var(--accent);background-size:300% 100%;animation:fillGlow 4s linear infinite;}
    @keyframes fillGlow{0%{background-position:0% 0%}50%{background-position:100% 0%}100%{background-position:0% 0%}}
    .progress-meta{display:flex;align-items:center;justify-content:space-between;margin-top:10px;font-size:13px;color:#bcd3ef;}
    
    /* Right stats */
    .greeting{font-size:22px;font-weight:700;}
    .g-sub{color:#b7d4f8;margin-top:6px;}
    .stat-grid{display:flex;gap:12px;margin-top:18px;}
    .stat{flex:1;padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));text-align:center;}
    .stat h5{font-size:12px;color:#bcd3ef;margin:0;}
    .stat p{font-weight:800;font-size:18px;margin-top:8px;}
    
    .notice{margin-top:18px;padding:12px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:#cfe6ff;font-size:13px;}
    .logout{margin-top:18px;padding:12px 18px;border-radius:10px;background:#ff5252;border:0;color:#fff;cursor:pointer;}
    
    /* Responsive */
    @media (max-width:920px){.main{flex-direction:column}.left{width:100%}}
    
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      
      <!-- Header -->
      <div class="header">
        <div class="brand">
          <div class="logo">VS</div>
          <div>
            <div class="title">Vision_S Dashboard</div>
            <div class="subtitle">Member Area</div>
          </div>
        </div>
        <div class="controls">
          <div class="tag" id="levelTag">Level 0</div>
          <button class="btn" id="refreshBtn">Refresh</button>
        </div>
      </div>
      
      <div class="main">
        <!-- Left panel -->
        <div class="left">
          <div class="profile-row">
            <div class="avatar" id="avatar">
              <!-- Avatar image or first letter -->
            </div>
            <div class="user-meta">
              <div class="user-name" id="displayName">User</div>
              <div class="user-email" id="displayEmail">user@example.com</div>
            </div>
          </div>
          
          <!-- Streak -->
          <div class="streak">
            <div style="font-size:13px;color:#bcd3ef">Login Streak</div>
            <div class="count" id="streakCount">0 ðŸ”¥</div>
            <div class="hint" id="streakHint">Login daily to maintain streak and increase level faster.</div>
          </div>
          
          <!-- Progress -->
          <div class="progress-card">
            <div class="level-row">
              <div>
                <div class="level-name" id="levelName">Bronze</div>
                <div style="font-size:12px;color:#bcd3ef">Progress towards next level</div>
              </div>
              <div class="level-badge" id="badge">Bronze</div>
            </div>
            
            <div class="progress-wrapper">
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width:0%"></div>
              </div>
            </div>
            
            <div class="progress-meta">
              <div id="progressPercent">0%</div>
              <div id="progressToNext">0 / 100</div>
            </div>
          </div>
          
        </div>
        
        <!-- Right panel -->
        <div class="right">
          <div class="greeting" id="greet">Welcome back!</div>
          <div class="g-sub" id="gSub">Your membership dashboard</div>
          
          <div class="stat-grid">
            <div class="stat">
              <h5>Current Level</h5>
              <p id="statLevel">Bronze</p>
            </div>
            <div class="stat">
              <h5>Progress</h5>
              <p id="statProgress">0%</p>
            </div>
            <div class="stat">
              <h5>Next Reward</h5>
              <p id="statNext">Unlock at 100%</p>
            </div>
          </div>
          
          <div class="notice" id="dailyQuote">
            Daily motivational quote will appear here.
          </div>
          
          <button class="logout" id="logoutBtn">Logout</button>
        </div>
      </div>
      
    </div>
  </div>
  
<script type="module">
  // ================================
  // Part 1: Firebase Auth + User Dashboard
  // ================================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBT8_Tvdq1WnwSvhFBCoGDn_VqGlYEVH6I",
    authDomain: "login-6e215.firebaseapp.com",
    projectId: "login-6e215",
    storageBucket: "login-6e215.firebasestorage.app",
    messagingSenderId: "503897234336",
    appId: "1:503897234336:web:8c888a3e78d7cccac822c5",
    measurementId: "G-6D44B4444K"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const LEVELS = ['Bronze','Silver','Gold','Platinum','Diamond','CROWN','CONQUEROR'];

  // DOM elements
  const displayNameEl = document.getElementById('displayName');
  const displayEmailEl = document.getElementById('displayEmail');
  const avatarEl = document.getElementById('avatar');
  const streakCountEl = document.getElementById('streakCount');
  const levelNameEl = document.getElementById('levelName');
  const badgeEl = document.getElementById('badge');
  const levelTag = document.getElementById('levelTag');
  const progressFill = document.getElementById('progressFill');
  const progressPercent = document.getElementById('progressPercent');
  const progressToNext = document.getElementById('progressToNext');
  const statLevel = document.getElementById('statLevel');
  const statProgress = document.getElementById('statProgress');
  const statNext = document.getElementById('statNext');
  const greet = document.getElementById('greet');
  const greetSub = document.getElementById('gSub');
  const dailyQuoteEl = document.getElementById('dailyQuote');
  const logoutBtn = document.getElementById('logoutBtn');
  const refreshBtn = document.getElementById('refreshBtn');

  let currentUser = null;
  let userRef = null;
  let localUser = { level:'Bronze', progress:0, streak:0, lastLogin:null, name:'User', email:'' };

  // Quotes
  const QUOTES = [
    "Push yourself, because no one else is going to do it for you.",
    "Consistency is what transforms average into excellence.",
    "Every day is a new opportunity to grow.",
    "Small progress is still progress.",
    "Stay focused and never give up."
  ];

  // Utility functions
  function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
  function toDateKey(ts){ const d=ts? (ts instanceof Date? ts: new Date(ts)) : new Date(); return `${d.getUTCFullYear()}-${(d.getUTCMonth()+1).toString().padStart(2,'0')}-${d.getUTCDate().toString().padStart(2,'0')}`;}

  // Render dashboard
  function renderUI(){
    const name = localUser.name || (currentUser && currentUser.email.split('@')[0]) || 'User';
    const email = localUser.email || (currentUser && currentUser.email) || '';
    displayNameEl.textContent = name;
    displayEmailEl.textContent = email;

    // Avatar: Gmail photoURL if exists
    if(localUser.photoURL){
      avatarEl.innerHTML = `<img src="${localUser.photoURL}" alt="avatar"/>`;
    } else {
      avatarEl.textContent = (name[0]||'U').toUpperCase();
    }

    const levelName = localUser.level || 'Bronze';
    levelNameEl.textContent = levelName;
    badgeEl.textContent = levelName;
    levelTag.textContent = `Level Â· ${levelName}`;
    
    const progress = clamp(localUser.progress,0,100);
    progressFill.style.width = `${progress}%`;
    progressPercent.textContent = `${progress}%`;
    progressToNext.textContent = `${progress} / 100`;
    statLevel.textContent = levelName;
    statProgress.textContent = `${progress}%`;
    statNext.textContent = 'Unlock at 100%';
    streakCountEl.innerHTML = `${localUser.streak || 0} ðŸ”¥`;
    greet.textContent = `Welcome back, ${name.split(' ')[0] || name}!`;
    greetSub.textContent = `Login daily to maintain streak and level up faster.`;
    
    // Random daily quote
    dailyQuoteEl.textContent = QUOTES[Math.floor(Math.random()*QUOTES.length)];
  }

  // Auth listener
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      window.location.href = "login.html";
      return;
    }
    currentUser = user;
    userRef = doc(db,'users',user.uid);
    const snap = await getDoc(userRef);
    if(!snap.exists()){
      // create user doc
      await setDoc(userRef,{
        name: user.displayName || user.email.split('@')[0],
        email: user.email,
        level: 'Bronze',
        progress: 0,
        streak: 0,
        lastLogin: serverTimestamp(),
        photoURL: user.photoURL || null
      });
      localUser = { name: user.displayName || user.email.split('@')[0], email:user.email, level:'Bronze', progress:0, streak:0, lastLogin:null, photoURL:user.photoURL||null };
    } else {
      const data = snap.data();
      localUser = {
        name: data.name || user.displayName || user.email.split('@')[0],
        email: data.email || user.email,
        level: data.level || 'Bronze',
        progress: data.progress || 0,
        streak: data.streak || 0,
        lastLogin: data.lastLogin ? data.lastLogin.toDate? data.lastLogin.toDate():new Date(data.lastLogin): null,
        photoURL: data.photoURL || user.photoURL || null
      };
    }

    // TODO: handle daily login logic (+1% progress for 2-day streak, -1% for streak break) - implemented in Part 2
    renderUI();
  });

  // Logout
  logoutBtn.addEventListener('click', async ()=>{
    await signOut(auth);
    window.location.href="login.html";
  });

  refreshBtn.addEventListener('click', async ()=>{
    const snap = await getDoc(userRef);
    if(snap.exists()){
      const data = snap.data();
      localUser.progress = data.progress || 0;
      localUser.level = data.level || 'Bronze';
      localUser.streak = data.streak || 0;
      renderUI();
    }
  });

</script>
  <script type="module">
  import { collection, getDocs, query, orderBy, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const ADMIN_EMAIL = "vsauravpandey99s@gmail.com";
  let isSuperAdmin = false;

  // Check super admin
  async function checkAdmin() {
    if (!currentUser) return false;
    if(currentUser.email === ADMIN_EMAIL){
      isSuperAdmin = true;
      addAdminPanel();
    }
  }

  // Add Super Admin panel dynamically
  function addAdminPanel() {
    const rightPanel = document.querySelector(".right");
    const adminDiv = document.createElement("div");
    adminDiv.id = "adminPanel";
    adminDiv.style.marginTop = "20px";
    adminDiv.style.padding = "16px";
    adminDiv.style.borderRadius = "12px";
    adminDiv.style.background = "linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))";

    adminDiv.innerHTML = `
      <h3>Super Admin Panel</h3>
      <p style="font-size:13px;color:#bcd3ef;margin-bottom:10px;">Manage all users</p>
      <div id="userList" style="max-height:300px;overflow-y:auto;"></div>
    `;
    rightPanel.appendChild(adminDiv);

    loadAllUsers();
  }

  // Load all users from Firestore
  async function loadAllUsers() {
    const userListDiv = document.getElementById("userList");
    userListDiv.innerHTML = "Loading users...";
    try {
      const q = query(collection(db, "users"), orderBy("name"));
      const snap = await getDocs(q);
      userListDiv.innerHTML = "";
      snap.forEach(docSnap => {
        const userData = docSnap.data();
        const userId = docSnap.id;
        const userItem = document.createElement("div");
        userItem.style.padding = "10px";
        userItem.style.borderBottom = "1px solid rgba(255,255,255,0.06)";
        userItem.innerHTML = `
          <strong>${userData.name}</strong> (${userData.email})<br>
          Level: 
          <select data-uid="${userId}" class="levelSelect">
            ${LEVELS.map(l=>`<option value="${l}" ${l===userData.level?'selected':''}>${l}</option>`).join('')}
          </select>
          Progress: <input type="number" min="0" max="100" value="${userData.progress}" data-uid="${userId}" class="progressInput" style="width:50px;">
          <button data-uid="${userId}" class="saveBtn" style="margin-left:8px;">Save</button>
        `;
        userListDiv.appendChild(userItem);
      });

      // Attach save listeners
      const saveButtons = userListDiv.querySelectorAll(".saveBtn");
      saveButtons.forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          const uid = btn.dataset.uid;
          const sel = userListDiv.querySelector(`.levelSelect[data-uid="${uid}"]`);
          const prog = userListDiv.querySelector(`.progressInput[data-uid="${uid}"]`);
          if(sel && prog){
            await updateDoc(doc(db,"users",uid),{
              level: sel.value,
              progress: clamp(Number(prog.value),0,100)
            });
            alert(`User ${uid} updated!`);
          }
        });
      });
    } catch(err){
      userListDiv.innerHTML = "Error loading users.";
      console.error(err);
    }
  }

  // Handle daily streak and progress logic
  async function updateStreakAndProgress() {
    if(!localUser.lastLogin) return;

    const todayKey = toDateKey(new Date());
    const lastLoginKey = toDateKey(localUser.lastLogin);
    const diffDays = (new Date(todayKey) - new Date(lastLoginKey))/(1000*3600*24);

    let newStreak = localUser.streak || 0;
    let newProgress = localUser.progress || 0;

    if(diffDays === 1){
      // consecutive login
      newStreak += 1;
      newProgress += 1;
    } else if(diffDays > 1){
      // streak break
      newStreak = 1;
      newProgress = clamp(newProgress - 1,0,100);
    }

    if(newProgress >= 100){
      // level up
      const currentLevelIndex = LEVELS.indexOf(localUser.level) || 0;
      const nextLevel = LEVELS[Math.min(currentLevelIndex+1,LEVELS.length-1)];
      localUser.level = nextLevel;
      newProgress = newProgress - 100;
      // Optional: trigger animation/pop up
      alert(`Congrats! You leveled up to ${nextLevel}`);
    }

    localUser.streak = newStreak;
    localUser.progress = clamp(newProgress,0,100);
    localUser.lastLogin = new Date();

    await updateDoc(userRef,{
      streak: localUser.streak,
      progress: localUser.progress,
      level: localUser.level,
      lastLogin: serverTimestamp()
    });

    renderUI();
  }

  // After auth, check if super admin
  onAuthStateChanged(auth, async ()=>{
    await checkAdmin();
    await updateStreakAndProgress();
  });

</script>

</body>
</html>
