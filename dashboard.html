<!doctype html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <title>Vision_S â€” Dashboard</title>
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
Â  <style>
Â  Â  :root{
Â  Â  Â  --bg1: #07070b;
Â  Â  Â  --glass: rgba(255,255,255,0.04);
Â  Â  Â  --glass-2: rgba(255,255,255,0.02);
Â  Â  Â  --accent1:#6ee7b7;
Â  Â  Â  --accent2:#60a5fa;
Â  Â  Â  --accent3:#a78bfa;
Â  Â  Â  --accent-grad: linear-gradient(90deg,var(--accent1),var(--accent2),var(--accent3));
Â  Â  Â  --muted: #b9d0ef;
Â  Â  Â  --max-level: 7;
Â  Â  }
Â  Â  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,-apple-system;color:#eaf6ff}
Â  Â  html,body{height:100%;margin:0;background:
Â  Â  Â  radial-gradient(1000px 600px at 10% 10%, rgba(96,165,250,0.06), transparent 5%),
Â  Â  Â  radial-gradient(900px 500px at 90% 90%, rgba(167,139,250,0.05), transparent 10%),
Â  Â  Â  linear-gradient(180deg,#06040b,#0b0433 40%,#1a044b 100%);
Â  Â  Â  overflow-y:auto;
Â  Â  }
Â  Â  .page {
Â  Â  Â  min-height:100vh;
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:center;
Â  Â  Â  padding:36px;
Â  Â  }

Â  Â  .shell {
Â  Â  Â  width:100%;
Â  Â  Â  max-width:1100px;
Â  Â  Â  border-radius:20px;
Â  Â  Â  padding:26px;
Â  Â  Â  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
Â  Â  Â  box-shadow: 0 20px 60px rgba(2,6,23,0.6), 0 6px 18px rgba(0,0,0,0.5);
Â  Â  Â  position:relative;
Â  Â  Â  overflow:hidden;
Â  Â  Â  border: 1px solid rgba(255,255,255,0.03);
Â  Â  }

Â  Â  /* header */
Â  Â  .header {
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:space-between;
Â  Â  Â  gap:12px;
Â  Â  }
Â  Â  .brand {
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  gap:14px;
Â  Â  }
Â  Â  .logo-wrap {
Â  Â  Â  width:68px; height:68px; border-radius:12px;
Â  Â  Â  display:flex; align-items:center; justify-content:center;
Â  Â  Â  background: var(--accent-grad);
Â  Â  Â  box-shadow: 0 8px 24px rgba(96,165,250,0.08);
Â  Â  Â  overflow:hidden;
Â  Â  }
Â  Â  .logo-wrap img { width:56px; height:auto; display:block; object-fit:contain; }

Â  Â  .title { font-weight:700; font-size:20px; color:#eaf6ff }
Â  Â  .subtitle { color:var(--muted); font-size:13px; margin-top:2px; }

Â  Â  .header-actions { display:flex; gap:10px; align-items:center; }

Â  Â  .tag {
Â  Â  Â  background: rgba(255,255,255,0.03);
Â  Â  Â  padding:8px 12px; border-radius:12px; font-size:13px; color:var(--muted);
Â  Â  }
Â  Â  .btn {
Â  Â  Â  background: transparent; border: 1px solid rgba(255,255,255,0.04);
Â  Â  Â  padding:8px 12px; border-radius:10px; cursor:pointer; color:inherit;
Â  Â  }
Â  Â  .btn.primary {
Â  Â  Â  background: var(--accent-grad); color:#04102a; border:none; font-weight:700;
Â  Â  Â  box-shadow: 0 6px 20px rgba(96,165,250,0.12);
Â  Â  }

Â  Â  /* main layout */
Â  Â  .main {
Â  Â  Â  display:flex;
Â  Â  Â  gap:24px;
Â  Â  Â  margin-top:18px;
Â  Â  Â  align-items:flex-start;
Â  Â  }

Â  Â  /* left column */
Â  Â  .left {
Â  Â  Â  width:360px;
Â  Â  Â  border-radius:14px;
Â  Â  Â  padding:16px;
Â  Â  Â  background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
Â  Â  Â  border: 1px solid rgba(255,255,255,0.02);
Â  Â  }

Â  Â  .profile-row { display:flex; gap:12px; align-items:center; }
Â  Â  .avatar-wrap {
Â  Â  Â  width:86px; height:86px; border-radius:999px; overflow:hidden; position:relative;
Â  Â  Â  display:flex; align-items:center; justify-content:center;
Â  Â  Â  background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.03), transparent 30%);
Â  Â  Â  transition: transform .18s ease;
Â  Â  Â  border: 3px solid rgba(255,255,255,0.03);
Â  Â  }
Â  Â  .avatar-wrap:hover { transform: translateY(-4px); box-shadow: 0 8px 30px rgba(63,94,255,0.08); }

Â  Â  .avatar { width:100%; height:100%; object-fit:cover; display:block; }

Â  Â  /* camera overlay */
Â  Â  .avatar-overlay {
Â  Â  Â  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
Â  Â  Â  background: linear-gradient(180deg, rgba(3,6,23,0.35), rgba(3,6,23,0.45));
Â  Â  Â  opacity:0; transition: opacity .15s ease;
Â  Â  }
Â  Â  .avatar-wrap:hover .avatar-overlay { opacity:1; cursor:pointer; }
Â  Â  .camera-dot {
Â  Â  Â  width:44px; height:44px; border-radius:999px; display:flex;align-items:center;justify-content:center;
Â  Â  Â  background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.06);
Â  Â  Â  font-weight:700; color:#fff;
Â  Â  Â  box-shadow: 0 6px 20px rgba(0,0,0,0.45);
Â  Â  }

Â  Â  .user-meta { display:flex; flex-direction:column; }
Â  Â  .user-name { font-size:18px; font-weight:700; }
Â  Â  .user-email { font-size:12.5px; color:var(--muted); margin-top:6px; word-break:break-all; }

Â  Â  .streak { margin-top:14px; padding:12px; border-radius:10px; background:var(--glass-2); text-align:center; }
Â  Â  .streak .count { font-size:20px; font-weight:800; margin-top:6px; }

Â  Â  .progress-card { margin-top:18px; padding:12px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); }
Â  Â  .level-row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
Â  Â  .level-name { font-weight:800; font-size:16px; }
Â  Â  .level-badge { padding:8px 14px; border-radius:999px; background: linear-gradient(90deg,#ffd47a,#d4af37); color:#241600; font-weight:800; }

Â  Â  .progress-bar { margin-top:12px; height:16px; border-radius:999px; background: rgba(255,255,255,0.03); overflow:hidden; }
Â  Â  .progress-fill { height:100%; width:0%; background: var(--accent-grad); transition: width .6s cubic-bezier(.2,.9,.2,1); }

Â  Â  .progress-meta { display:flex; justify-content:space-between; margin-top:10px; color:var(--muted); font-size:13px; }

Â  Â  .controls-small { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }

Â  Â  /* membership */
Â  Â  .membership { margin-top:14px; padding:12px; border-radius:10px; background: rgba(255,255,255,0.02); color:#ffdca3; font-weight:700; text-align:center; }

Â  Â  /* right column */
Â  Â  .right { flex:1; padding:18px; border-radius:12px; }
Â  Â  .greeting { font-size:22px; font-weight:700; }
Â  Â  .g-sub { color:var(--muted); margin-top:6px; }

Â  Â  .stat-grid { display:flex; gap:12px; margin-top:18px; }
Â  Â  .stat { flex:1; padding:16px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); text-align:center; }
Â  Â  .stat h5 { font-size:12px; color:var(--muted); margin:0 }
Â  Â  .stat p { font-weight:800; font-size:18px; margin-top:8px; }

Â  Â  .notice { margin-top:18px; padding:12px; border-radius:10px; background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color:#cfe6ff; font-size:13px; }
Â  Â  .logout { margin-top:18px; padding:12px 18px; border-radius:10px; background:#ff5252; border:0; color:#fff; cursor:pointer; }

Â  Â  .admin-box { margin-top:16px; padding:12px; border-radius:12px; background: rgba(255,255,255,0.02); display:none; flex-direction:column; gap:8px; }
Â  Â  .admin-row { display:flex; gap:8px; align-items:center; }
Â  Â  .small-input { padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:inherit; }

Â  Â  /* responsive */
Â  Â  @media (max-width:960px){ .main{ flex-direction:column; } .left{ width:100%; } .brand{ gap:8px; } .logo-wrap{ width:56px; height:56px; } }

Â  </style>
</head>
<body>
Â  <div class="page">
Â  Â  <div class="shell" id="shell">
Â  Â  Â  <div class="header">
Â  Â  Â  Â  <div class="brand">
Â  Â  Â  Â  Â  <div class="logo-wrap" id="logoWrap">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="companyLogo" src="LOGO_URL_HERE" alt="Logo" onerror="this.style.display='none'">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="logoText" style="display:none;font-weight:800;color:#04102a;padding:8px 12px;border-radius:8px;">VISION_S</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div class="title">Vision_S Dashboard</div>
Â  Â  Â  Â  Â  Â  <div class="subtitle">Member Area â€” Premium</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="header-actions">
Â  Â  Â  Â  Â  <div class="tag" id="levelTag">Level 0 Â· Bronze</div>
Â  Â  Â  Â  Â  <button class="btn" id="adminPageBtn">Admin Page</button>
Â  Â  Â  Â  Â  <button class="btn" id="refreshBtn">Refresh</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="main">
Â  Â  Â  Â  <div class="left">

Â  Â  Â  Â  Â  <div class="profile-row">
Â  Â  Â  Â  Â  Â  <div class="avatar-wrap" id="avatarWrap" title="Click to change profile picture">
Â  Â  Â  Â  Â  Â  Â  <img id="avatar" class="avatar" src="https://i.ibb.co/bm7M7C6/default.jpg" alt="avatar">
Â  Â  Â  Â  Â  Â  Â  <div class="avatar-overlay" id="avatarOverlay" aria-hidden="true">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="camera-dot">ðŸ“·</div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="user-meta">
Â  Â  Â  Â  Â  Â  Â  <div class="user-name" id="displayName">User</div>
Â  Â  Â  Â  Â  Â  Â  <div class="user-email" id="displayEmail">user@example.com</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="streak">
Â  Â  Â  Â  Â  Â  <div style="font-size:13px;color:var(--muted)">Login Streak</div>
Â  Â  Â  Â  Â  Â  <div class="count" id="streakCount">0 ðŸ”¥</div>
Â  Â  Â  Â  Â  Â  <div class="hint" id="streakHint">Login daily to maintain streak and increase level faster.</div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="progress-card">
Â  Â  Â  Â  Â  Â  <div class="level-row">
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="level-name" id="levelName">Bronze</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:12px;color:var(--muted)">Progress towards next level</div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="level-badge" id="badge">Bronze</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="progress-wrapper" style="margin-top:12px">
Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-fill" id="progressFill" style="width:0%"></div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="progress-meta">
Â  Â  Â  Â  Â  Â  Â  <div id="progressPercent">0%</div>
Â  Â  Â  Â  Â  Â  Â  <div id="progressToNext">0 / 100</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="controls-small">
Â  Â  Â  Â  Â  Â  Â  <button class="btn" id="simulateDaily">Simulate +2%</button>
Â  Â  Â  Â  Â  Â  Â  <button class="btn" id="simulateBreak">Simulate -5%</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="membership" id="membershipBox" style="margin-top:12px">
Â  Â  Â  Â  Â  Â  <div style="font-size:12px;color:var(--muted)">Membership Code</div>
Â  Â  Â  Â  Â  Â  <div id="membershipCode" style="margin-top:8px;color:#ffdca3">Not assigned</div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="right">
Â  Â  Â  Â  Â  <div class="greeting" id="greet">Welcome back!</div>
Â  Â  Â  Â  Â  <div class="g-sub" id="gSub">Your membership dashboard</div>

Â  Â  Â  Â  Â  <div class="stat-grid">
Â  Â  Â  Â  Â  Â  <div class="stat">
Â  Â  Â  Â  Â  Â  Â  <h5>Current Level</h5>
Â  Â  Â  Â  Â  Â  Â  <p id="statLevel">Bronze</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="stat">
Â  Â  Â  Â  Â  Â  Â  <h5>Progress</h5>
Â  Â  Â  Â  Â  Â  Â  <p id="statProgress">0%</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="stat">
Â  Â  Â  Â  Â  Â  Â  <h5>Next Reward</h5>
Â  Â  Â  Â  Â  Â  Â  <p id="statNext">Unlock at 100%</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="notice">
Â  Â  Â  Â  Â  Â  <strong>Streak Tip:</strong> Login daily to keep your streak. If you miss more than one day your streak resets and you'll lose 5% progress (progress never becomes negative).
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <button class="logout" id="logoutBtn">Logout</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:12px;color:var(--muted);font-size:13px">
Â  Â  Â  Â  Â  Â  Admin features are available on a separate page. Click <strong>Admin Page</strong> and enter your admin code.
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <input id="avatarInput" type="file" accept="image/*" style="display:none" />

<script type="module">
/* =========================
Â  Full dashboard logic
Â  - Firebase Auth + Firestore + Storage
Â  - Realtime sync (onSnapshot)
Â  - Avatar hover edit / upload
Â  - Admin page launcher
Â  ========================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, onSnapshot, query, collection, where, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";

/* ---- Firebase config (your config) ---- */
const firebaseConfig = {
Â  apiKey: "AIzaSyBT8_Tvdq1WnwSvhFBCoGDn_VqGlYEVH6I",
Â  authDomain: "login-6e215.firebaseapp.com",
Â  projectId: "login-6e215",
Â  storageBucket: "login-6e215.firebasestorage.app",
Â  messagingSenderId: "503897234336",
Â  appId: "1:503897234336:web:8c888a3e78d7cccac822c5",
Â  measurementId: "G-6D44B4444K"
};
/* --------------------------------------- */

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* UI refs */
const avatarEl = document.getElementById('avatar');
const avatarWrap = document.getElementById('avatarWrap');
const avatarOverlay = document.getElementById('avatarOverlay');
const avatarInput = document.getElementById('avatarInput');
const displayNameEl = document.getElementById('displayName');
const displayEmailEl = document.getElementById('displayEmail');
const streakCountEl = document.getElementById('streakCount');
const levelNameEl = document.getElementById('levelName');
const badgeEl = document.getElementById('badge');
const levelTag = document.getElementById('levelTag');
const progressFill = document.getElementById('progressFill');
const progressPercent = document.getElementById('progressPercent');
const progressToNext = document.getElementById('progressToNext');
const statLevel = document.getElementById('statLevel');
const statProgress = document.getElementById('statProgress');
const statNext = document.getElementById('statNext');
const greet = document.getElementById('greet');
const greetSub = document.getElementById('gSub');
const membershipCodeEl = document.getElementById('membershipCode');

const logoutBtn = document.getElementById('logoutBtn');
const refreshBtn = document.getElementById('refreshBtn');
const simulateDailyBtn = document.getElementById('simulateDaily');
const simulateBreakBtn = document.getElementById('simulateBreak');
const adminPageBtn = document.getElementById('adminPageBtn');

const LEVELS = ['Bronze','Silver','Gold','Platinum','Diamond','CROWN','CONQUEROR'];
const ADMIN_PAGE = 'admin.html'; // separate admin page
const ADMIN_CODE = 'vision_s_admin_2025';

let currentUser = null;
let userRef = null;Â  Â  Â // doc ref
let unsubSnapshot = null;
let localUser = { level:1, progress:0, streak:0, lastLogin:null, name:'User', email:'', membershipCode:null, photoURL:null };

/* small helpers */
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
function toDateKey(ts){ const d = ts ? (ts instanceof Date ? ts : new Date(ts)) : new Date(); const y = d.getUTCFullYear(); const m = (d.getUTCMonth()+1).toString().padStart(2,'0'); const day = d.getUTCDate().toString().padStart(2,'0'); return `${y}-${m}-${day}`; }

/* render UI */
function renderUI(){
Â  displayNameEl.textContent = localUser.name || (currentUser && currentUser.email.split('@')[0]) || 'User';
Â  displayEmailEl.textContent = localUser.email || (currentUser && currentUser.email) || '';
Â  avatarEl.src = localUser.photoURL || currentUser?.photoURL || 'https://i.ibb.co/bm7M7C6/default.jpg';

Â  const levelIndex = clamp(localUser.level,1,LEVELS.length);
Â  const levelName = LEVELS[levelIndex - 1] || 'Bronze';
Â  levelNameEl.textContent = levelName;
Â  badgeEl.textContent = levelName;
Â  levelTag.textContent = `Level ${levelIndex} Â· ${levelName}`;

Â  const progress = clamp(Math.round(localUser.progress||0),0,999);
Â  progressFill.style.width = `${clamp(progress,0,100)}%`;
Â  progressPercent.textContent = `${clamp(progress,0,100)}%`;
Â  progressToNext.textContent = `${clamp(progress,0,100)} / 100`;
Â  statLevel.textContent = levelName;
Â  statProgress.textContent = `${clamp(progress,0,100)}%`;
Â  statNext.textContent = 'Unlock at 100%';
Â  streakCountEl.innerHTML = `${localUser.streak || 0} ðŸ”¥`;
Â  membershipCodeEl.textContent = localUser.membershipCode ?? 'Not assigned';
Â  greet.textContent = `Welcome back, ${ (localUser.name || '').split(' ')[0] || 'Member' }!`;
Â  greetSub.textContent = `Login daily to maintain streak and level up faster.`;
}

/* confetti */
const confettiCanvas = document.createElement('canvas');
confettiCanvas.id = 'confettiHelper';
confettiCanvas.style.position = 'absolute';
confettiCanvas.style.left = 0; confettiCanvas.style.top = 0; confettiCanvas.style.width = '100%'; confettiCanvas.style.height='100%';
confettiCanvas.style.pointerEvents='none';
document.getElementById('shell').appendChild(confettiCanvas);
const confettiCtx = confettiCanvas.getContext('2d');
function resizeConfetti(){ confettiCanvas.width = confettiCanvas.clientWidth; confettiCanvas.height = confettiCanvas.clientHeight; }
window.addEventListener('resize', resizeConfetti); resizeConfetti();
let confettiPieces = [];
function spawnConfetti(amount=80){
Â  confettiPieces = []; const w = confettiCanvas.width, h = confettiCanvas.height;
Â  for(let i=0;i<amount;i++) confettiPieces.push({x:Math.random()*w,y:Math.random()*-h*0.6,vx:(Math.random()-0.5)*6,vy:Math.random()*4+2,r:Math.random()*6+4,color:`hsl(${Math.random()*360},80%,60%)`,rot:Math.random()*360,rotSpeed:(Math.random()-0.5)*8});
Â  requestAnimationFrame(stepConfetti);
}
function stepConfetti(){
Â  confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
Â  for(let p of confettiPieces){ p.x+=p.vx; p.y+=p.vy; p.vy+=0.12; p.rot+=p.rotSpeed; confettiCtx.save(); confettiCtx.translate(p.x,p.y); confettiCtx.rotate(p.rot*Math.PI/180); confettiCtx.fillStyle=p.color; confettiCtx.fillRect(-p.r/2,-p.r/2,p.r,p.r*0.6); confettiCtx.restore(); }
Â  confettiPieces = confettiPieces.filter(p=>p.y < confettiCanvas.height + 50);
Â  if(confettiPieces.length>0) requestAnimationFrame(stepConfetti);
}

/* normalize and save (handles level-ups) */
async function normalizeAndSave(){
Â  let leveled = false;
Â  while(localUser.progress >= 100 && localUser.level < LEVELS.length){
Â  Â  localUser.progress -= 100;
Â  Â  localUser.level += 1;
Â  Â  leveled = true;
Â  }
Â  if(localUser.level > LEVELS.length) localUser.level = LEVELS.length;
Â  if(userRef){
Â  Â  await updateDoc(userRef, {
Â  Â  Â  level: localUser.level,
Â  Â  Â  progress: localUser.progress,
Â  Â  Â  streak: localUser.streak,
Â  Â  Â  membershipCode: localUser.membershipCode ?? null,
Â  Â  Â  lastLogin: serverTimestamp()
Â  Â  });
Â  }
Â  renderUI();
Â  if(leveled){
Â  Â  spawnConfetti(140);
Â  Â  document.getElementById('shell').animate([{transform:'scale(1)'},{transform:'scale(1.02)'},{transform:'scale(1)'}],{duration:700});
Â  }
}

/* ensure user doc exists (creates if missing) */
async function ensureUserDoc(uid, userObj){
Â  userRef = doc(db, 'users', uid);
Â  const snap = await getDoc(userRef);
Â  if(!snap.exists()){
Â  Â  const now = new Date();
Â  Â  await setDoc(userRef, {
Â  Â  Â  name: userObj.displayName || (userObj.email?userObj.email.split('@')[0]:'User'),
Â  Â  Â  email: userObj.email || '',
Â  Â  Â  level: 1,
Â  Â  Â  progress: 0,
Â  Â  Â  streak: 1,
Â  Â  Â  membershipCode: null,
Â  Â  Â  photoURL: userObj.photoURL || null,
Â  Â  Â  lastLogin: serverTimestamp()
Â  Â  });
Â  Â  localUser = { level:1, progress:0, streak:1, lastLogin: now.toISOString(), name: userObj.displayName || userObj.email.split('@')[0], email: userObj.email, membershipCode:null, photoURL: userObj.photoURL||null };
Â  Â  renderUI();
Â  Â  return;
Â  } else {
Â  Â  const data = snap.data();
Â  Â  localUser.level = data.level ?? 1;
Â  Â  localUser.progress = data.progress ?? 0;
Â  Â  localUser.streak = data.streak ?? 0;
Â  Â  localUser.lastLogin = data.lastLogin ? (data.lastLogin.toDate ? data.lastLogin.toDate().toISOString() : new Date(data.lastLogin).toISOString()) : null;
Â  Â  localUser.name = data.name ?? (userObj.displayName || userObj.email.split('@')[0]);
Â  Â  localUser.email = data.email ?? userObj.email;
Â  Â  localUser.membershipCode = data.membershipCode ?? null;
Â  Â  localUser.photoURL = data.photoURL ?? userObj.photoURL ?? null;
Â  }
}

/* handle daily login */
async function handleDailyLogin(){
Â  if(!localUser) return;
Â  const nowKey = toDateKey(new Date());
Â  const lastKey = localUser.lastLogin ? toDateKey(new Date(localUser.lastLogin)) : null;
Â  if(lastKey === nowKey) return;
Â  if(!lastKey){
Â  Â  localUser.streak = 1;
Â  Â  localUser.progress = clamp(localUser.progress + 2, 0, 999);
Â  } else {
Â  Â  const now = new Date();
Â  Â  const last = new Date(localUser.lastLogin);
Â  Â  const nowUTC = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());
Â  Â  const lastUTC = Date.UTC(last.getUTCFullYear(), last.getUTCMonth(), last.getUTCDate());
Â  Â  const diffDays = Math.floor((nowUTC - lastUTC) / (1000 * 60 * 60 * 24));
Â  Â  if(diffDays === 1){
Â  Â  Â  localUser.streak = (localUser.streak || 0) + 1;
Â  Â  Â  localUser.progress = clamp(localUser.progress + 2, 0, 999);
Â  Â  } else if(diffDays > 1){
Â  Â  Â  localUser.streak = 1;
Â  Â  Â  localUser.progress = Math.max(0, localUser.progress - 5);
Â  Â  }
Â  }
Â  if(userRef){
Â  Â  await updateDoc(userRef, {
Â  Â  Â  level: localUser.level,
Â  Â  Â  progress: localUser.progress,
Â  Â  Â  streak: localUser.streak,
Â  Â  Â  lastLogin: serverTimestamp()
Â  Â  });
Â  }
}

/* realtime subscription to user doc */
function subscribeToUserDoc(uid){
Â  if(unsubSnapshot) unsubSnapshot(); // detach old
Â  userRef = doc(db, 'users', uid);
Â  unsubSnapshot = onSnapshot(userRef, (snap) => {
Â  Â  if(!snap.exists()) return;
Â  Â  const d = snap.data();
Â  Â  // update localUser from snapshot (admin changes will reflect)
Â  Â  localUser.level = d.level ?? localUser.level;
Â  Â  localUser.progress = d.progress ?? localUser.progress;
Â  Â  localUser.streak = d.streak ?? localUser.streak;
Â  Â  localUser.lastLogin = d.lastLogin ? (d.lastLogin.toDate ? d.lastLogin.toDate().toISOString() : new Date(d.lastLogin).toISOString()) : localUser.lastLogin;
Â  Â  localUser.name = d.name ?? localUser.name;
Â  Â  localUser.email = d.email ?? localUser.email;
Â  Â  localUser.membershipCode = d.membershipCode ?? localUser.membershipCode;
Â  Â  localUser.photoURL = d.photoURL ?? localUser.photoURL;
Â  Â  renderUI();
Â  }, (err) => { console.error('Snapshot error', err); });
}

/* Auth listener */
onAuthStateChanged(auth, async (user) => {
Â  if(!user){
Â  Â  // not signed in â€” go to login page
Â  Â  window.location.href = "login.html";
Â  Â  return;
Â  }
Â  currentUser = user;
Â  // ensure doc exists, then subscribe
Â  await ensureUserDoc(user.uid, user);
Â  subscribeToUserDoc(user.uid);
Â  // apply daily login logic
Â  await handleDailyLogin();
Â  await normalizeAndSave();
Â  renderUI();
});

/* logout */
logoutBtn.addEventListener('click', async () => {
Â  await signOut(auth);
Â  window.location.href = "login.html";
});

/* refresh */
refreshBtn.addEventListener('click', async () => {
Â  if(currentUser) {
Â  Â  const snap = await getDoc(doc(db,'users',currentUser.uid));
Â  Â  if(snap.exists()){
Â  Â  Â  // snapshot will update UI automatically
Â  Â  Â  renderUI();
Â  Â  }
Â  }
Â  document.getElementById('shell').animate([{opacity:0.95},{opacity:1}],{duration:250});
});

/* test simulate */
simulateDailyBtn.addEventListener('click', async () => {
Â  localUser.progress = clamp(localUser.progress + 2, 0, 999);
Â  localUser.streak = (localUser.streak || 0) + 1;
Â  await normalizeAndSave();
});
simulateBreakBtn.addEventListener('click', async () => {
Â  localUser.streak = 1;
Â  localUser.progress = Math.max(0, localUser.progress - 5);
Â  await normalizeAndSave();
});

/* Admin page button: open separate admin page, protected by prompt for code */
adminPageBtn.addEventListener('click', () => {
Â  const code = prompt('Enter Admin Code to open Admin Page:');
Â  if(code === ADMIN_CODE){
Â  Â  // open admin.html in new tab
Â  Â  window.open(ADMIN_PAGE, '_blank');
Â  } else {
Â  Â  alert('Wrong admin code.');
Â  }
});

/* Avatar hover click => trigger file input */
avatarWrap.addEventListener('click', () => avatarInput.click());

/* Avatar upload handling */
avatarInput.addEventListener('change', async (e) => {
Â  const file = e.target.files?.[0];
Â  if(!file) return;
Â  if(!currentUser) return alert('Not signed in');

Â  // optional: small client-side validation
Â  if(file.size > 3 * 1024 * 1024) return alert('Please select an image under 3MB.');

Â  // upload to storage and update profile and firestore
Â  try {
Â  Â  const path = `profilepics/${currentUser.uid}/${Date.now()}_${file.name}`;
Â  Â  const r = sRef(storage, path);
Â  Â  const snap = await uploadBytes(r, file);
Â  Â  const url = await getDownloadURL(snap.ref);

Â  Â  // update auth profile (photoURL) and users doc
Â  Â  try { await updateProfile(currentUser, { photoURL: url }); } catch(e){ console.warn('updateProfile failed', e); }
Â  Â  await updateDoc(doc(db,'users',currentUser.uid), { photoURL: url });

Â  Â  // success â€” snapshot will update avatar automatically
Â  Â  alert('Profile uploaded successfully.');
Â  } catch (err) {
Â  Â  console.error(err);
Â  Â  alert('Upload failed. See console.');
Â  }
});

/* small utility: query users by email (used by admin page) */
/* we'll export a small function to window so admin page window can call it (same origin) */
window._visionS = {
Â  findUserDocByEmail: async (email) => {
Â  Â  const q = query(collection(db,'users'), where('email','==', email));
Â  Â  const snaps = await getDocs(q);
Â  Â  if(snaps.empty) return null;
Â  Â  const docSnap = snaps.docs[0];
Â  Â  return { id: docSnap.id, data: docSnap.data() };
Â  }
};

/* initial render */
renderUI();

/* helper clamp export (optional) */
window._visionS.clamp = clamp;

</script>
</body>
</html>
